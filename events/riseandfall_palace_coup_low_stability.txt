namespace = palace_coup

palace_coup.1001 = {
	type = character_event
	title = palace_coup.1001.t
	desc = palace_coup.1001.desc
	theme = court

	left_portrait = {
		character = root
	}
	right_portrait = {
		character = scope:challenger
	}

	immediate = {
		root = {
			every_held_title = {
				add_to_list = lost_titles
			}
		}
		# Select challenger respecting realm sex succession laws on the root's realm.
		if = {
			limit = { root = { OR = { has_realm_law = male_only_law has_realm_law = male_preference_law } } }
			random_courtier = {
				limit = {
					is_knight = yes
					is_landed = no
					is_alive = yes
					is_male = yes
				}
				save_scope_as = challenger
			}
		}
		else_if = {
			limit = { root = { OR = { has_realm_law = female_only_law has_realm_law = female_preference_law } } }
			random_courtier = {
				limit = {
					is_knight = yes
					is_landed = no
					is_alive = yes
					is_female = yes
				}
				save_scope_as = challenger
			}
		}
		else = {
			random_courtier = {
				limit = {
					is_knight = yes
					is_landed = no
					is_alive = yes
				}
				save_scope_as = challenger
			}
		}
		if = {
			limit = { NOT = { exists = scope:challenger } }
			# Fallback challenger selection also respects male/female-only succession laws
			if = {
				limit = { root = { OR = { has_realm_law = male_only_law has_realm_law = male_preference_law } } }
				random_courtier = {
					limit = {
						is_landed = no
						is_alive = yes
						NOT = { is_close_family_of = root }
						age > 16
						is_male = yes
					}
					save_scope_as = challenger
				}
			}
			else_if = {
				limit = { root = { OR = { has_realm_law = female_only_law has_realm_law = female_preference_law } } }
				random_courtier = {
					limit = {
						is_landed = no
						is_alive = yes
						NOT = { is_close_family_of = root }
						age > 16
						is_female = yes
					}
					save_scope_as = challenger
				}
			}
			else = {
				random_courtier = {
					limit = {
						is_landed = no
						is_alive = yes
						NOT = { is_close_family_of = root }
						age > 16
					}
					save_scope_as = challenger
				}
			}
		}
		# set a cooldown variable used by the low stability system
		set_variable = { name = low_stability_cooldown value = yes days = 1825 }
		# (duel will be resolved when the player chooses option A)
	}

	option = {
		name = palace_coup.1001.a

		# Only show if we actually have a challenger
		trigger = { exists = scope:challenger }

		duel = {
			skill = prowess
			target = scope:challenger

			# Actor (root) wins outcome (heavily disfavored)
			5 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 1
					min = -20
				}

				# Hidden: kill challenger and purge courtiers without previewing in the option tooltip
				hidden_effect = {
					scope:challenger = {
						death = {
							death_reason = death_duel
							killer = root
						}
					}
					root = {
						# Kill ~50% of unlanded knights in the ruler's court
						every_courtier = {
							limit = {
								is_knight = yes
								is_landed = no
								is_alive = yes
							}
							random_list = {
								50 = {
									death = {
										death_reason = death_in_palace_coup
										killer = scope:challenger
									}
								}
								50 = { }
							}
						}

						# Kill ~20% of the remaining non-knight courtiers
						every_courtier_or_guest = {
							limit = {
								exists = yes
								is_alive = yes
								NOT = { is_knight = yes }
							}
							random_list = {
								20 = {
									death = {
										death_reason = death_in_palace_coup
										killer = scope:challenger
									}
								}
								80 = { }
							}
						}
					}
				}
			}

			# Challenger wins outcome (heavily favored)
			95 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -1
					min = -20
				}

				# Challenger seizes titles while root is still alive, then kills root
				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
				}
				# Transfer all non-barony titles from root to challenger
				every_held_title = {
					limit = {
						holder = root
						NOT = { tier = tier_barony }
					}
					change_title_holder = {
						holder = scope:challenger
						change = scope:change
						take_baronies = yes
					}
				}
				resolve_title_and_vassal_change = scope:change
				scope:challenger = {
					if = {
						limit = { root = { has_legitimacy = yes } }
						add_legitimacy = -1200
					}
				}
				# Kill the ruler after titles have been reassigned
				death = {
					death_reason = death_duel
					killer = scope:challenger
				}
				scope:challenger = {
					add_trait = murderer
				}

				# Hidden purge deaths (so victims aren't previewed) and visible toast
				hidden_effect = {
					root = {
						# Kill ~50% of unlanded knights in the ruler's court
						every_courtier = {
							limit = {
								is_knight = yes
								is_landed = no
								is_alive = yes
							}
							random_list = {
								50 = {
									death = {
										death_reason = death_in_palace_coup
										killer = scope:challenger
									}
								}
								50 = { }
							}
						}

						# Kill ~50% of the remaining non-knight courtiers
						every_courtier_or_guest = {
							limit = {
								exists = yes
								is_alive = yes
								NOT = { is_knight = yes }
							}
							random_list = {
								50 = {
									death = {
										death_reason = death_in_palace_coup
										killer = scope:challenger
									}
								}
								50 = { }
							}
						}
					}
				}

				# Visible toast informing the player about the purge
				send_interface_message = {
					type = event_war_bad
					title = palace_coup.purge_toast
					left_icon = root
					right_icon = scope:challenger
				}
			}


		}

		ai_chance = {
			# Increase base so negative modifiers can't push the weight below zero.
			base = 100
		  modifier = {
			  add = 80
			  # Strongly favor the duel if root's prowess is higher than the challenger
			  NOT = { prowess_diff = { target = scope:challenger value <= 0 } }
		  }
		  modifier = {
			  add = -80
			  # Strongly discourage duel if root is weaker in prowess than the challenger
			  prowess_diff = { target = scope:challenger value <= -1 }
		  }
		}
	}

	option = {
		name = palace_coup.1001.b

		# Only show if we actually have a challenger
		trigger = {
			exists = scope:challenger
			primary_title = { tier >= tier_duchy }
		}

		duel = {
			skill = intrigue
			target = scope:challenger

			# Success: root successfully evades/covers their tracks and escapes (heavily disfavored)
			95 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = 3.5
					min = -49
				}



				# Transfer root's capital county (if any) to challenger, then transfer all duchy+ titles
				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
				}
				# Transfer capital county specifically (if it exists and is held by root).
				# Use an explicit `root = { capital_county = ... }` block so the parser
				# doesn't attempt to resolve `capital_county` at tooltip-time and
				# so we operate on root's capital safely.
				if = {
					limit = { root = { capital_county = { exists = yes } } }
					root = {
						capital_county = {
							change_title_holder = {
								holder = scope:challenger
								change = scope:change
								take_baronies = yes
							}
						}
					}
				}
				# Transfer all duchy+ titles (exclude counties and baronies)
				every_held_title = {
					limit = {
						holder = root
						NOT = {
							OR = {
								tier = tier_county
								tier = tier_barony
							}
						}
					}
					change_title_holder = {
						holder = scope:challenger
						change = scope:change
						take_baronies = yes
					}
				}
                
	                # Make the old ruler (root) a vassal of the challenger and
	                # transfer direct vassals to the challenger in the same change
					root = {
						change_liege = {
							liege = scope:challenger
							change = scope:change
						}
					}
				resolve_title_and_vassal_change = scope:change
				# Trigger escape follow-up: present the reclaim-your-throne event to root
				root = { trigger_event = { id = palace_coup.1002 } }
				scope:challenger = {
					if = {
						limit = { root = { has_legitimacy = yes } }
						add_legitimacy = -1200
					}
				}

				# Make root and the challenger rivals of each other (reason key exists in localization)
				root = {
					if = {
						limit = { can_set_relation_rival_trigger = { CHARACTER = scope:challenger } }
						set_relation_rival = {
							target = scope:challenger
							reason = riseandfall_adventurer_became_rival
						}
					}
				}
				scope:challenger = {
					if = {
						limit = { can_set_relation_rival_trigger = { CHARACTER = root } }
						set_relation_rival = {
							target = root
							reason = riseandfall_adventurer_became_rival
						}
					}
				}
			}

			# Failure: challenger captures/seizes the ruler (heavily disfavored)
			5 = {
				compare_modifier = {
					value = scope:duel_value
					multiplier = -3.5
					min = -49
				}

				create_title_and_vassal_change = {
					type = conquest
					save_scope_as = change
				}
				# Transfer all non-barony titles from root to challenger
				every_held_title = {
					limit = {
						holder = root
						NOT = { tier = tier_barony }
					}
					change_title_holder = {
						holder = scope:challenger
						change = scope:change
						take_baronies = yes
					}
				}
					resolve_title_and_vassal_change = scope:change
					scope:challenger = {
						if = {
							limit = { root = { has_legitimacy = yes } }
							add_legitimacy = -1200
						}
					}
				# Make root and the challenger rivals of each other (reason key exists in localization)
				root = {
					if = {
						limit = { can_set_relation_rival_trigger = { CHARACTER = scope:challenger } }
						set_relation_rival = {
							target = scope:challenger
							reason = riseandfall_adventurer_became_rival
						}
					}
				}
				scope:challenger = {
					if = {
						limit = { can_set_relation_rival_trigger = { CHARACTER = root } }
						set_relation_rival = {
							target = root
							reason = riseandfall_adventurer_became_rival
						}
					}
				}
				# Kill the ruler after titles have been reassigned
				death = {
					death_reason = death_duel
					killer = scope:challenger
                    
				}
				scope:challenger = {
					add_trait = murderer
				}
			}
		}

		ai_chance = {
			# Smaller base: intrigue should have limited influence. Prowess check below will dominate.
			base = 20
		  modifier = {
			  add = 10
			  # Slightly favor escape if root's intrigue is higher than the challenger
			  NOT = { intrigue_diff = { target = scope:challenger value <= 0 } }
		  }
		  modifier = {
			  add = -10
			  # Slight penalty if root is weaker in intrigue
			  intrigue_diff = { target = scope:challenger value <= -1 }
		  }
		  modifier = {
			  add = 100
			  # If root is notably weaker in prowess than the challenger, strongly favor escape
			  prowess_diff = { target = scope:challenger value <= -1 }
		  }
		}
	}

}

palace_coup.1002 = {
	type = character_event
	title = palace_coup.1002.t
	desc = palace_coup.1002.d
	theme = court

    left_portrait = {
		character = root
	}

	option = {
		name = palace_coup.1002.a
			# Give root strong claims on all titles lost to the challenger (when option chosen)
			every_in_list = {
				list = lost_titles
				root = { make_claim_strong = prev }
			}
			# Trigger the warlord path for the challenger only when this option is chosen
			scope:challenger = {
				trigger_event = { id = warlord.1001 }
			}
			ai_chance = { base = 100 }
	}
}
