##########################
# Rise and Fall - Puppet Low Stability Event
# Triggered when low stability roll succeeds. Offers a powerful vassal the chance to become puppet master via regency diarchy.

namespace = puppet

puppet.1001 = {
    type = character_event
    title = puppet.1001.t
    desc = puppet.1001.d
    theme = realm

    right_portrait = root
    immediate = {
        # Set low stability cooldown on the liege when this event fires
    set_variable = { name = low_stability_cooldown value = yes days = 1825 }
        try_start_diarchy = regency
    }

    option = {
        name = puppet.1001.a
        # Attempt to start a regency diarchy on the liege, then choose a random powerful vassal to offer the puppet
        random_powerful_vassal = {
            # Defensive limits: ensure we pick a direct, landed, adult vassal (not spouse/courtier/etc.)
            limit = {
                is_landed = yes
                age >= 16
            }
            trigger_event = puppet.1002
        }
    }
}

puppet.1002 = {
    type = character_event
    title = puppet.1002.t
    desc = puppet.1002.d
    theme = realm
    immediate = {
        # Save our liege as a scope for use by effects (so scope:liege is defined)
        liege = { save_scope_as = liege }
        # Save the event root (the chosen vassal) so we can reference it in fallbacks
        root = { save_scope_as = candidate_vassal }
    }
    left_portrait = liege
    right_portrait = root

    option = {
        name = puppet.1002.a
        ai_chance = {
            factor = 100  # AI always accepts
        }
        # Accept: Have the liege set the chosen (root) character as diarch
        scope:liege = {
            # Validate candidate is old enough before attempting to set diarch
            if = {
                limit = {
                    scope:candidate_vassal = { age >= 16 }
                }
                set_diarch = scope:candidate_vassal
                set_diarchy_type = puppet_regency
                set_diarchy_swing = 90
            }
            else = {
                # Candidate invalid for diarchy (e.g. not a landed vassal) — pick another vassal if possible
                random_powerful_vassal = {
                    limit = {
                            NOT = { this = scope:candidate_vassal }
                            is_landed = yes
                            age >= 16
                    }
                    trigger_event = puppet.1002
                }
            }
        }
    }

    option = {
        name = puppet.1002.b
        ai_chance = {
            factor = 0  # AI never declines
        }
        # Decline: have the liege pick another random powerful vassal (excluding the current root) and trigger the event for them
        liege = {
            random_powerful_vassal = {
                limit = { NOT = { this = scope:candidate_vassal } }
                trigger_event = puppet.1002
            }
        }
    }
}
