# Combined auto-create titles for AI counts (duchy), rulers (kingdom), and kings (empire)
# This single effect consolidates duplication and can be called by the old entrypoint scripts
# or directly by the on_action registration.

# Helper effect: Destroy dynamic/titular titles of the same tier when creating a proper de jure title
# Should be called on the ruler, with scope:target_title set to the newly created title
riseandfall_destroy_same_tier_dynamic_titles_se = {
    # Helper: destroy any titular (dynamic) titles of the same tier as the newly created title
    # Save the root character to enforce proper scope when combining character and title checks
    save_scope_as = destroy_helper_root
    scope:destroy_helper_root = {
            every_held_title = {
            # Do not touch special titular titles that should remain (head-of-faith / noble family titles)
            limit = {
                tier = scope:target_title.tier
                NOT = { this = scope:target_title }
                is_titular = yes
                NOT = { is_head_of_faith = yes }
                NOT = { is_noble_family_title = yes }
                NOT = { is_holy_order = yes }
                NOT = { is_figurehead_title = yes }
            }
            save_scope_as = destroy_held_title
            # Call destroy_title from the saved ruler scope using the saved title scope
            scope:destroy_helper_root = {
                if = {
                    limit = { exists = scope:destroy_held_title }
                    destroy_title = scope:destroy_held_title
                }
            }
        }
    }
}

# Standalone effect: Destroy titular titles if the ruler has a non-titular title of the same tier
# Can be called independently (e.g., on yearly pulse) to clean up dynamic titles
# Should be called on the ruler (character scope)
riseandfall_cleanup_titular_titles_se = {
    # Save the original scope so we can run character-scoped checks while iterating titles
    save_scope_as = cleanup_ruler

    # For every titular title held by the ruler, destroy it if the ruler holds
    # any other non-titular title of the same or higher rank. This covers cases such as
    # a titular duchy being left behind when the ruler gains a non-titular kingdom/empire, etc.
    every_held_title = {
        # Only iterate titular titles that are not head of faith, noble family, holy order, or figurehead titles.
        # Those are special and must not be destroyed by the AI creation/cleanup process.
        limit = {
            is_titular = yes
            NOT = { is_head_of_faith = yes }
            NOT = { is_noble_family_title = yes }
            NOT = { is_holy_order = yes }
            NOT = { is_figurehead_title = yes }
        }
        save_scope_as = titular_held

        # Run the checks in the character scope and keep scope isolation to avoid
        # mixing `landed_title` and `character` scopes inside trigger/effect limits.
        scope:cleanup_ruler = {
                # County titular: destroy when any non-titular county OR higher (duchy/kingdom/empire/hegemony) is held
                if = {
                    limit = { scope:titular_held = { tier = tier_county } }
                    scope:cleanup_ruler = {
                        if = {
                            limit = {
                                any_held_title = {
                                    NOT = { this = scope:titular_held }
                                    is_titular = no
                                    OR = {
                                        tier = tier_county
                                        tier = tier_duchy
                                        tier = tier_kingdom
                                        tier = tier_empire
                                        tier = tier_hegemony
                                    }
                                }
                            }
                            destroy_title = scope:titular_held
                        }
                    }
                }

            # Duchy titular: destroy when any non-titular duchy OR higher (kingdom/empire/hegemony) is held
            if = {
                limit = { scope:titular_held = { tier = tier_duchy } }
                scope:cleanup_ruler = {
                    if = {
                        limit = {
                            any_held_title = {
                                NOT = { this = scope:titular_held }
                                is_titular = no
                                OR = {
                                    tier = tier_duchy
                                    tier = tier_kingdom
                                    tier = tier_empire
                                    tier = tier_hegemony
                                }
                            }
                        }
                        destroy_title = scope:titular_held
                    }
                }
            }

            # Kingdom titular: destroy when any non-titular kingdom OR higher (empire/hegemony) is held
            if = {
                limit = { scope:titular_held = { tier = tier_kingdom } }
                scope:cleanup_ruler = {
                    if = {
                        limit = {
                            any_held_title = {
                                NOT = { this = scope:titular_held }
                                is_titular = no
                                OR = {
                                    tier = tier_kingdom
                                    tier = tier_empire
                                    tier = tier_hegemony
                                }
                            }
                        }
                        destroy_title = scope:titular_held
                    }
                }
            }

            # Empire titular: destroy when any non-titular empire OR higher (hegemony) is held
            if = {
                limit = { scope:titular_held = { tier = tier_empire } }
                scope:cleanup_ruler = {
                    if = {
                        limit = {
                            any_held_title = {
                                NOT = { this = scope:titular_held }
                                is_titular = no
                                OR = {
                                    tier = tier_empire
                                    tier = tier_hegemony
                                }
                            }
                        }
                        destroy_title = scope:titular_held
                    }
                }
            }

            # Hegemony titular: destroy when a non-titular hegemony is held (same tier only, highest available)
            if = {
                limit = { scope:titular_held = { tier = tier_hegemony } }
                scope:cleanup_ruler = {
                    if = {
                        limit = {
                            any_held_title = {
                                NOT = { this = scope:titular_held }
                                is_titular = no
                                tier = tier_hegemony
                            }
                        }
                        destroy_title = scope:titular_held
                    }
                }
            }
        }
    }
}

riseandfall_ai_create_titles_se = {
    # Iterate all rulers (player and AI will be further filtered per-tier)
    every_ruler = {
        limit = { is_landed = yes }
        save_scope_as = acting_ruler
        
        # First, cleanup any existing titular titles if they have non-titular equivalents
        riseandfall_cleanup_titular_titles_se = yes

        # Duchies (AI rulers of at least kingdom tier can create duchies)
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 1000
            limit = {
                tier = tier_duchy
                scope:acting_ruler = {
                    is_ai = yes
                    OR = {
                        primary_title.tier = tier_kingdom
                        primary_title.tier = tier_empire
                        primary_title.tier = tier_hegemony
                        government_allows = administrative
                    }
                }
                # Prevent same-tier creation unless:
                # 1. Single-heir succession law allows it, OR
                # 2. Primary title is titular (dynamic) - should replace it with proper title
                NOT = {
                    AND = {
                        tier = scope:acting_ruler.primary_title.tier
                        NOT = { scope:acting_ruler = { has_realm_law = single_heir_succession_law } }
                        NOT = { scope:acting_ruler.primary_title = { is_titular = yes } }
                    }
                }
            }
            save_scope_as = target_title
            scope:target_title = {
                try_create_important_action = {
                    important_action_type = action_can_create_title
                    landed_title = this
                }
            }
            scope:acting_ruler = {
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }
                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }
                resolve_title_and_vassal_change = scope:title_change
                # Destroy any dynamic titles of the same tier
                riseandfall_destroy_same_tier_dynamic_titles_se = yes
                # Cleanup any titular titles if the ruler holds a non-titular same/higher tier
                riseandfall_cleanup_titular_titles_se = yes
            }
        }

        # Kingdoms (AI emperors and hegemons creating kingdoms)
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 1000
            limit = {
                tier = tier_kingdom
                scope:acting_ruler = {
                    is_ai = yes
                    OR = { primary_title.tier = tier_empire primary_title.tier = tier_hegemony government_allows = administrative }
                }
                # Prevent same-tier creation unless:
                # 1. Single-heir succession law allows it, OR
                # 2. Primary title is titular (dynamic) - should replace it with proper title
                NOT = {
                    AND = {
                        tier = scope:acting_ruler.primary_title.tier
                        NOT = { scope:acting_ruler = { has_realm_law = single_heir_succession_law } }
                        NOT = { scope:acting_ruler.primary_title = { is_titular = yes } }
                    }
                }
            }
            save_scope_as = target_title
            scope:target_title = {
                try_create_important_action = {
                    important_action_type = action_can_create_title
                    landed_title = this
                }
            }
            scope:acting_ruler = {
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }
                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }
                resolve_title_and_vassal_change = scope:title_change
                # Destroy any dynamic titles of the same tier
                riseandfall_destroy_same_tier_dynamic_titles_se = yes
                # Cleanup any titular titles if the ruler holds a non-titular same/higher tier
                riseandfall_cleanup_titular_titles_se = yes
            }
        }

        # Empires (AI kings promoting to empire, or AI emperors with titular empire replacing it)
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 99
            limit = {
                tier = tier_empire
                scope:acting_ruler = {
                    is_ai = yes
                    OR = {
                        primary_title.tier = tier_kingdom
                        # Also allow empire-tier rulers if their primary is titular
                        AND = {
                            primary_title.tier = tier_empire
                            primary_title = { is_titular = yes }
                        }
                        government_allows = administrative
                    }
                }
                # Prevent same-tier creation unless:
                # 1. Single-heir succession law allows it, OR
                # 2. Primary title is titular (dynamic) - should replace it with proper title
                NOT = {
                    AND = {
                        tier = scope:acting_ruler.primary_title.tier
                        NOT = { scope:acting_ruler = { has_realm_law = single_heir_succession_law } }
                        NOT = { scope:acting_ruler.primary_title = { is_titular = yes } }
                    }
                }
                # Hegemons must not create empires (extra guard)
                NOT = { scope:acting_ruler = { primary_title.tier = tier_hegemony } }
            }
            save_scope_as = target_title
            scope:target_title = {
                try_create_important_action = {
                    important_action_type = action_can_create_title
                    landed_title = this
                }
            }
            scope:acting_ruler = {
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }
                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }
                resolve_title_and_vassal_change = scope:title_change
                # Destroy any dynamic titles of the same tier
                riseandfall_destroy_same_tier_dynamic_titles_se = yes
                # Cleanup any titular titles if the ruler holds a non-titular same/higher tier
                riseandfall_cleanup_titular_titles_se = yes
            }
        }
    }
# Rules enforced:
# - AI should create titles when possible, but they must NOT create a title that is the same tier as their
#   own primary title unless their realm uses the single-heir succession law (single_heir_succession_law).
# - Creators for each target tier remain the same as before: duchies are created by rulers at kingdom+ tier,
#   kingdoms by empire/hegemon, and empires (promotions) by kings.
# - When in doubt, prefer lower-tier creation unless explicit promotion (king -> empire) is intended.
}
# Auto-usurp titles for AI rulers
# Runs on the yearly global pulse (riseandfall_ai_usurp_titles on_action)

riseandfall_ai_usurp_titles_se = {
    # Iterate all rulers (players and AI)
    every_ruler = {
        # Only run for AI-controlled rulers who are landed
        limit = {
            is_ai = yes
            is_landed = yes
        }

        # Save scope for use inside iterators
        save_scope_as = acting_ruler

        # Iterate all usurpable titles and try to usurp them
        ordered_alert_usurpable_title = {
            order_by = tier
            check_range_bounds = no
            max = 1000

                limit = {
                    # Check for single-heir and partition laws in acting_ruler scope; don't compare ``tier`` here.
                    scope:acting_ruler = {
                        OR = {
                            has_realm_law = single_heir_succession_law
                            OR = {
                                has_realm_law = partition_succession_law
                                has_realm_law = confederate_partition_succession_law
                                has_realm_law = high_partition_succession_law
                            }
                            government_has_flag = government_is_administrative
                        }
                    }

                    # If a partition law flows through, ensure the target title tier matches the acting ruler's primary title.
                    AND = {
                        scope:acting_ruler = {
                            OR = {
                                has_realm_law = partition_succession_law
                                has_realm_law = confederate_partition_succession_law
                                has_realm_law = high_partition_succession_law
                            }
                        }
                        tier = scope:acting_ruler.primary_title.tier
                    }

                    # Prevent hegemons from attempting to usurp empire-tier titles
                    NOT = {
                        AND = {
                            tier = tier_empire
                            scope:acting_ruler = { primary_title.tier = tier_hegemony }
                        }
                    }

                    # If the government is administrative, block duplicates when the target title's tier equals acting's primary.
                    AND = {
                        scope:acting_ruler = { government_has_flag = government_is_administrative }
                        NOT = { tier = scope:acting_ruler.primary_title.tier }
                    }
                }

            # Try to usurp the title if possible
            save_scope_as = target_title

            # Create an important-action alert for the engine/UI so players (and logs) know this title is usurpable
            scope:target_title = {
                try_create_important_action = {
                    important_action_type = action_can_usurp_title
                    landed_title = this
                }
            }
            scope:acting_ruler = {
                create_title_and_vassal_change = {
                    type = conquest
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }

                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }

                resolve_title_and_vassal_change = scope:title_change
                # Destroy any dynamic titles of the same tier
                riseandfall_destroy_same_tier_dynamic_titles_se = yes
                # Cleanup any titular titles if the ruler holds a non-titular same/higher tier
                riseandfall_cleanup_titular_titles_se = yes
            }
        }
    }
}

# Backwards-compatibility thin wrappers: preserve old effect names
riseandfall_ai_create_kingdoms_se = { riseandfall_ai_create_titles_se = yes }
riseandfall_ai_create_duchies_se = { riseandfall_ai_create_titles_se = yes }
riseandfall_ai_create_empires_se = { riseandfall_ai_create_titles_se = yes }
