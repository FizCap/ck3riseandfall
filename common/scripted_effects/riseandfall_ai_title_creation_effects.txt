# Auto-create kingdom titles for AI emperors and kings
# Runs on the yearly global pulse (riseandfall_ai_create_kingdoms on_action)

riseandfall_ai_create_kingdoms_se = {
    # Iterate all rulers (players and AI)
    every_ruler = {
        # Only run for AI-controlled rulers whose primary title is kingdom or empire tier
        limit = {
            is_ai = yes
            OR = {
                primary_title.tier = tier_empire
                primary_title.tier = tier_kingdom
            }
            is_landed = yes
        }

        # Save scope for use inside iterators
        save_scope_as = acting_ruler

        # Iterate all creatable titles and try to create kingdoms
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 99

            limit = {
                tier = tier_kingdom
                if = {
                    limit = {
                        scope:acting_ruler = {
                            OR = {
                                has_realm_law = partition_succession_law
                                has_realm_law = confederate_partition_succession_law
                                has_realm_law = high_partition_succession_law
                            }
                        }
                    }
                    NOT = { tier = scope:acting_ruler.primary_title.tier }
                }
            }

            # Try to create the kingdom if possible
            save_scope_as = target_title
            scope:acting_ruler = {
                # Use the engine helper used by decisions/events to create titles and transfer holdings
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }

                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }

                resolve_title_and_vassal_change = scope:title_change

                # Set primary title if the actor is a king and the created kingdom is higher tier or equivalent
                if = {
                    limit = {
                        primary_title.tier = tier_kingdom
                        prev.tier = tier_kingdom
                    }
                    # For kings creating other kingdoms, only set as primary if it's more prestigious
                    if = {
                        limit = {
                            # prev is a title/landed_title scope returned by change_title_holder;
                            # monthly_character_income is a character trigger, so compare the holder character's income instead
                            prev = {
                                holder = {
                                    monthly_character_income > scope:acting_ruler.primary_title.holder.monthly_character_income
                                }
                            }
                        }
                        set_primary_title_to = prev
                    }
                }
                else_if = {
                    limit = {
                        primary_title.tier = tier_empire
                    }
                    # For emperors, don't change primary title - keep the empire
                }
            }
        }
    }
}

# Auto-create duchy titles for AI counts
# Also runs on the yearly global pulse
riseandfall_ai_create_duchies_se = {
    # Iterate all rulers (players and AI)
    every_ruler = {
        # Only run for AI-controlled counts
        limit = {
            is_ai = yes
            primary_title.tier = tier_county
            is_landed = yes
        }

        # Save scope for use inside iterators
        save_scope_as = acting_count

        # Iterate all creatable titles and try to create duchies
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 99  # Limit to prevent excessive duchy creation

            limit = {
                tier = tier_duchy
            }

            # Try to create the duchy if possible
            save_scope_as = target_title
            scope:acting_count = {
                # Use the engine helper used by decisions/events to create titles and transfer holdings
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }

                prev = {
                    change_title_holder = {
                        holder = scope:acting_count
                        change = scope:title_change
                    }
                }

                resolve_title_and_vassal_change = scope:title_change

                # Set as primary title since it's higher tier than county
                set_primary_title_to = prev
            }
        }
    }
}

# Auto-create empire titles for AI emperors and kings  
# Also runs on the yearly global pulse
riseandfall_ai_create_empires_se = {
    # Iterate all rulers (players and AI)
    every_ruler = {
        # Only run for AI-controlled rulers whose primary title is kingdom or empire tier
        limit = {
            is_ai = yes
            OR = {
                primary_title.tier = tier_empire
                primary_title.tier = tier_kingdom
            }
            is_landed = yes
        }

        # Save scope for use inside iterators
        save_scope_as = acting_ruler

        # Iterate all creatable titles and try to create empires
        ordered_alert_creatable_title = {
            order_by = tier
            check_range_bounds = no
            max = 99  # Limit empire creation to prevent excessive titles

            limit = {
                tier = tier_empire
                if = {
                    limit = {
                        scope:acting_ruler = {
                            OR = {
                                has_realm_law = partition_succession_law
                                has_realm_law = confederate_partition_succession_law
                                has_realm_law = high_partition_succession_law
                            }
                        }
                    }
                    NOT = { tier = scope:acting_ruler.primary_title.tier }
                }
            }

            # Try to create the empire if possible
            save_scope_as = target_title
            scope:acting_ruler = {
                # Use the engine helper used by decisions/events to create titles and transfer holdings
                create_title_and_vassal_change = {
                    type = created
                    save_scope_as = title_change
                    add_claim_on_loss = no
                }

                prev = {
                    change_title_holder = {
                        holder = scope:acting_ruler
                        change = scope:title_change
                    }
                }

                resolve_title_and_vassal_change = scope:title_change

                # Set as primary title if it's higher tier than current primary
                if = {
                    limit = {
                        primary_title.tier = tier_kingdom
                        prev.tier = tier_empire
                    }
                    set_primary_title_to = prev
                }
                else_if = {
                    limit = {
                        primary_title.tier = tier_empire
                        prev.tier = tier_empire
                    }
                    # For emperors creating other empires, only set as primary if it's more prestigious
                    if = {
                        limit = {
                            # Compare the income of the holder character of the prev title against the acting ruler's primary title holder
                            prev = {
                                holder = {
                                    monthly_character_income > scope:acting_ruler.primary_title.holder.monthly_character_income
                                }
                            }
                        }
                        set_primary_title_to = prev
                    }
                }
            }
        }
    }
}
