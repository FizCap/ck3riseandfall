##########################
# Rise and Fall - Low Stability yearly roll
# Runs once per year from an on_action. For each ruler, compute chance = (100 - stability_score) * 0.05 (capped at 5%).
# If the random check succeeds, trigger an event (riseandfall.1001 - warlord).

riseandfall_low_stability_roll_se = {
    # For every independent ruler, compute chance once using the ruler's stability
        # Perform computations inside the saved scope so scope:independent_ruler variables resolve correctly
        scope:ruler_low_stability = {
            # Ensure a default stability score exists so scripts don't error when it's missing
            if = { limit = { NOT = { has_variable = riseandfall_realm_stability_score } } set_variable = { name = riseandfall_realm_stability_score value = 50 } }
            if = {
                limit = { NOT = { has_variable = low_stability_cooldown } }
                # Compute chance with a curved (approx power 1.5) formula based on highest held title tier.
                # Thresholds: county = 30, duchy = 35, kingdom = 40, empire = 45, hegemony = 50.
                # Approach: tmp_diff = max(0, threshold - stability_score)
                # Chance ~= floor( (tmp_diff^2 * 100) / (threshold^2) ); minimum 1% when tmp_diff > 0.
                set_variable = { name = stability_threshold value = 30 }
                if = { limit = { highest_held_title_tier >= tier_duchy } set_variable = { name = stability_threshold value = 35 } }
                if = { limit = { highest_held_title_tier >= tier_kingdom } set_variable = { name = stability_threshold value = 40 } }
                if = { limit = { highest_held_title_tier >= tier_empire } set_variable = { name = stability_threshold value = 45 } }
                if = { limit = { highest_held_title_tier >= tier_hegemony } set_variable = { name = stability_threshold value = 50 } }

                set_variable = { name = tmp_diff value = 0 }
                change_variable = { name = tmp_diff add = var:riseandfall_realm_stability_score }
                change_variable = { name = tmp_diff multiply = -1 }
                change_variable = { name = tmp_diff add = var:stability_threshold }
                clamp_variable = { name = tmp_diff min = 0 max = 50 }

                set_variable = { name = tmp_chance value = 0 }
                # If stability > threshold, chance should be 0%
                if = {
                    limit = { var:riseandfall_realm_stability_score > var:stability_threshold }
                    set_variable = { name = tmp_chance value = 0 }
                }
                else = {
                    # tmp_sq = tmp_diff^2
                    set_variable = { name = tmp_sq value = var:tmp_diff }
                    change_variable = { name = tmp_sq multiply = var:tmp_diff }

                    # Scale to percentage: (tmp_sq * 100) / (threshold^2)
                    set_variable = { name = tmp_chance value = var:tmp_sq }
                    change_variable = { name = tmp_chance multiply = 100 }
                    change_variable = { name = tmp_chance divide = var:stability_threshold }
                    change_variable = { name = tmp_chance divide = var:stability_threshold }

                    # Ensure at least 1% when tmp_diff > 0
                    if = { limit = { AND = { var:tmp_diff > 0 var:tmp_chance < 1 } } set_variable = { name = tmp_chance value = 1 } }
                }

                # Dynamic Story Mode: Very large and massive realms get stronger minimum chances
                if = {
                    limit = { has_variable = riseandfall_massive_realm }
                    if = { limit = { var:tmp_chance < 3 } set_variable = { name = tmp_chance value = 3 } }
                }
                else_if = {
                    limit = { has_variable = riseandfall_very_large_realm }
                    if = { limit = { var:tmp_chance < 2 } set_variable = { name = tmp_chance value = 2 } }
                }
                else_if = {
                    limit = { has_variable = riseandfall_large_realm }
                    if = { limit = { var:tmp_chance < 1 } set_variable = { name = tmp_chance value = 1 } }
                }

                # Store the calculated chance on the character for tooltip display (persists until next yearly update)
                set_variable = { name = riseandfall_low_stability_chance value = var:tmp_chance }

                # Roll once for the independent ruler. If it succeeds, notify the liege and add stability
                random = {
                    chance = var:tmp_chance
                    # Trigger a random low stability event
                    riseandfall_low_stability_random_event = yes
                }
            }
            else = {
                # If on cooldown, chance is 0
                set_variable = { name = riseandfall_low_stability_chance value = 0 }
            }
        }
    }

##########################
# Rise and Fall - Low Stability Random Event Selector
# Randomly selects between warlord uprising, peasant unrest, and puppet master offer

riseandfall_low_stability_random_event = {
    # Prefilter eligibility into simple flags to guarantee a fallback without chained logic.
    # rf_puppet_ok = 1 if puppet event is allowed (no existing puppet_regency)
    # rf_adventurer_ok = 1 if adventurer event is allowed (empire-tier ruler)
    # rf_realm_split_ok = 1 if realm split is allowed (kingdom+ ruler with 2+ powerful vassals)
    set_variable = { name = rf_puppet_ok value = 1 days = 14 }
    if = { limit = { has_diarchy_type = puppet_regency } set_variable = { name = rf_puppet_ok value = 0 days = 14 } }

    set_variable = { name = rf_adventurer_ok value = 0 days = 14 }
    # Allow adventurer invasion for kingdom-tier rulers or higher (requires highest-held title >= kingdom)
    if = { limit = { highest_held_title_tier >= tier_kingdom } set_variable = { name = rf_adventurer_ok value = 1 days = 14 } }

    # Realm split eligibility: use shared trigger for consistent rules (kingdom+ and 2+ vassals, low stability)
    set_variable = { name = rf_realm_split_ok value = 0 days = 14 }
    if = {
        limit = { riseandfall_can_realm_split_trigger = yes }
        set_variable = { name = rf_realm_split_ok value = 1 days = 14 }
    }

    # Palace coup not possible for theocracies or republics
    set_variable = { name = rf_palace_coup_ok value = 1 days = 14 }
    if = { limit = { government_has_flag = government_is_theocracy } set_variable = { name = rf_palace_coup_ok value = 0 days = 14 } }
    if = { limit = { government_has_flag = government_is_republic } set_variable = { name = rf_palace_coup_ok value = 0 days = 14 } }

    # Handle all eligibility combinations with realm split as a rare but impactful option
    if = {
        limit = { AND = { var:rf_realm_split_ok = 1 var:rf_puppet_ok = 1 var:rf_adventurer_ok = 1 } }
        # All options available including realm split (rare weight)
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
    }
    else_if = {
        limit = { AND = { var:rf_realm_split_ok = 1 var:rf_puppet_ok = 1 var:rf_adventurer_ok = 0 } }
        # Realm split + puppet allowed
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
    }
    else_if = {
        limit = { AND = { var:rf_realm_split_ok = 1 var:rf_puppet_ok = 0 var:rf_adventurer_ok = 1 } }
        # Realm split + adventurer allowed
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
    }
    else_if = {
        limit = { AND = { var:rf_realm_split_ok = 1 var:rf_puppet_ok = 0 var:rf_adventurer_ok = 0 } }
        # Only realm split from special options
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = realm_split.1001 } }
            }
        }
    }
    else_if = {
        limit = { AND = { var:rf_puppet_ok = 1 var:rf_adventurer_ok = 1 } }
        # Both puppet and adventurer available, no realm split
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
            }
        }
    }
    else_if = {
        limit = { AND = { var:rf_puppet_ok = 1 var:rf_adventurer_ok = 0 } }
        # Only puppet allowed
        random_list = {
            1 = { trigger_event = { id = warlord.1001 } }
            1 = { trigger_event = { id = palace_coup.1001 } }
        }
    }
    else_if = {
        limit = { AND = { var:rf_puppet_ok = 0 var:rf_adventurer_ok = 1 } }
        # Only adventurer allowed
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = adventurer.1001 } }
            }
        }
    }
    else = {
        # Neither allowed: fallback to warlord / palace coup
        if = { limit = { var:rf_palace_coup_ok = 1 }
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
                1 = { trigger_event = { id = palace_coup.1001 } }
            }
        }
        else = {
            random_list = {
                1 = { trigger_event = { id = warlord.1001 } }
            }
        }
    }
}

##########################
# Rise and Fall - Create Adventurer Invasion
# Creates a random number (3-10) of adventurers with claims on the ruler's primary title

riseandfall_create_adventurer_invasion_se = {
    # Called on the ruler (root)
    save_scope_as = ruler_root  # Save the ruler for use in iterators
    scope:ruler_root = { save_scope_as = independent_ruler }

    # Initialize variables for tooltip safety
    set_variable = { name = selected value = 0 }
    scope:ruler_root = { set_variable = { name = selected value = 0 } }
    # Also initialize key variables on root (the original scope) so tooltip evaluation can access them
    root = {
        set_variable = { name = selected value = 0 }
        set_variable = { name = claimant_count value = 0 }
        set_variable = { name = to_select value = 0 }
        set_variable = { name = remaining_to_select value = 0 }
        set_variable = { name = num_existing value = 1 }
        set_variable = { name = num_generated value = 1 }
        set_variable = { name = remaining_courtier_slots value = 0 }
        set_variable = { name = generated_to_create value = 0 }
        set_variable = { name = no_more_courtiers value = 0 }
    }
    # Mirror same initial variables on the saved ruler scope so change_variable in that scope
    # operates on value-typed variables (prevents 'Variable not of the value scope type' errors)
    scope:ruler_root = {
        set_variable = { name = claimant_count value = 0 }
        set_variable = { name = to_select value = 0 }
        set_variable = { name = remaining_to_select value = 0 }
        set_variable = { name = num_existing value = 1 }
        set_variable = { name = num_generated value = 1 }
        set_variable = { name = remaining_courtier_slots value = 0 }
        set_variable = { name = generated_to_create value = 0 }
        set_variable = { name = no_more_courtiers value = 0 }
    }
    set_variable = { name = claimant_count value = 0 }
    set_variable = { name = to_select value = 0 }
    set_variable = { name = remaining_to_select value = 0 }
    set_variable = { name = num_existing value = 1 }
    set_variable = { name = num_generated value = 1 }
    set_variable = { name = remaining_courtier_slots value = 0 }
    set_variable = { name = generated_to_create value = 0 }
    set_variable = { name = no_more_courtiers value = 0 }
    # Determine number of adventurers from existing claimants: random 1-5
    set_variable = { name = num_existing value = 1 }
    random_list = {
        20 = { set_variable = { name = num_existing value = 1 } }
        20 = { set_variable = { name = num_existing value = 2 } }
        20 = { set_variable = { name = num_existing value = 3 } }
        20 = { set_variable = { name = num_existing value = 4 } }
        20 = { set_variable = { name = num_existing value = 5 } }
    }
    # Determine number of adventurers from generated characters: random 1-5
    set_variable = { name = num_generated value = 1 }
    random_list = {
        20 = { set_variable = { name = num_generated value = 1 } }
        20 = { set_variable = { name = num_generated value = 2 } }
        20 = { set_variable = { name = num_generated value = 3 } }
        20 = { set_variable = { name = num_generated value = 4 } }
        20 = { set_variable = { name = num_generated value = 5 } }
    }

    # Handle existing claimants
    # Count existing claimants (store on saved ruler scope)
    set_variable = { name = claimant_count value = 0 }
    every_living_character = {
        limit = { has_claim_on = root.primary_title }
        root = { change_variable = { name = claimant_count add = 1 } }
    }
    # Mirror selection count to saved scope and track remaining slots
    set_variable = { name = to_select value = var:num_existing }
    root = { set_variable = { name = to_select value = var:num_existing } }
    set_variable = { name = remaining_to_select value = var:to_select }
    root = { set_variable = { name = remaining_to_select value = var:to_select } }

    # Pick claimants one-by-one using random_character to avoid iterator-time var comparisons
    while = {
        limit = { var:remaining_to_select > 0 }
        # clear any previous saved candidate
        scope:ruler_root = { clear_saved_scope = adventurer_candidate }

        # Attempt to pick a random eligible claimant
        scope:ruler_root = {
            every_living_character = {
                limit = {
                    has_claim_on = scope:ruler_root.primary_title
                    is_landed = no
                    NOT = { has_government = landless_adventurer_government }
                    age >= 16
                    NOT = { has_character_flag = riseandfall_newadventurer }
                    NOT = { has_trait_with_flag = can_not_marry }
                }
                save_scope_as = adventurer_candidate
            }
        }

        if = {
            limit = { exists = scope:adventurer_candidate }
            scope:adventurer_candidate = {
                # Disqualify if too close to the ruler (allies/spouse/heir)
                set_variable = { name = rf_disqualify value = 0 }
                if = {
                    limit = {
                        OR = {
                            is_allied_to = root
                            is_spouse_of = root
                            is_heir_of = root
                            is_primary_heir_of = root
                            is_player_heir_of = root
                        }
                    }
                    set_variable = { name = rf_disqualify value = 1 }
                }

                if = {
                    limit = { var:rf_disqualify == 0 }
                    # Select this claimant
                    if = { limit = { exists = scope:adventurer_candidate scope:adventurer_candidate = { is_alive = yes } } scope:adventurer_candidate = { riseandfall_do_create_adventurer_se = yes } }
                    scope:ruler_root = { change_variable = { name = remaining_to_select subtract = 1 } }
                    root = { change_variable = { name = remaining_to_select subtract = 1 } }
                }
                else = {
                    # Found claimant but disqualified (ally/heir/etc.) -> consume one attempt to avoid infinite loop
                    scope:ruler_root = { change_variable = { name = remaining_to_select subtract = 1 } }
                    root = { change_variable = { name = remaining_to_select subtract = 1 } }
                }
                remove_variable = rf_disqualify
            }
        }
        else = {
            # No eligible claimants found -> stop attempting
            set_variable = { name = remaining_to_select value = 0 }
            root = { set_variable = { name = remaining_to_select value = 0 } }
        }
    }

    # Clean up mirrored variables used for tooltip-safety
    remove_variable = to_select
    scope:ruler_root = { remove_variable = to_select }
    remove_variable = remaining_to_select
    scope:ruler_root = { remove_variable = remaining_to_select }

    # Try to conscript existing courtiers before generating new adventurers
    set_variable = { name = remaining_courtier_slots value = var:num_generated }
    set_variable = { name = no_more_courtiers value = 0 }
    # Setup a best-score tracker on the saved ruler scope so we can pick the "best" courtier
    scope:ruler_root = { set_variable = { name = tmp_best_adventurer_score value = -9999 } }
    while = {
        limit = {
            var:remaining_courtier_slots > 0
            var:no_more_courtiers == 0
        }
        clear_saved_scope = adventurer_candidate
        root = {
            # Select the best courtier by aggregated stats rather than a single random pick
            every_courtier = {
                limit = {
                    age >= 16
                    is_landed = no
                    NOT = { has_government = landless_adventurer_government }
                    NOT = { has_character_flag = riseandfall_newadventurer }
                    NOT = { has_trait_with_flag = can_not_marry }
                    NOT = {
                        OR = {
                            is_allied_to = root
                            is_spouse_of = root
                            is_heir_of = root
                            is_primary_heir_of = root
                            is_player_heir_of = root
                        }
                    }
                }
                # Compute a weighted-stat 'candidate_total' to choose the best candidate
                set_variable = { name = candidate_total value = diplomacy }
                change_variable = { name = candidate_total add = martial }
                change_variable = { name = candidate_total add = stewardship }
                change_variable = { name = candidate_total add = intrigue }
                change_variable = { name = candidate_total add = learning }

                # Save candidate score into the ruler scope for safe comparison
                save_scope_as = candidate_for_score
                scope:ruler_root = { set_variable = { name = tmp_candidate value = scope:candidate_for_score.var:candidate_total } }

                # If this candidate is better than the saved best, select them
                if = {
                    limit = { scope:ruler_root = { has_variable = tmp_candidate } }
                    if = {
                        limit = { scope:ruler_root.var:tmp_candidate > scope:ruler_root.var:tmp_best_adventurer_score }
                        save_scope_as = adventurer_candidate
                        scope:ruler_root = { set_variable = { name = tmp_best_adventurer_score value = scope:ruler_root.var:tmp_candidate } }
                    }
                }
            }
        }
        if = {
            limit = { exists = scope:adventurer_candidate }
            scope:adventurer_candidate = {
                # Disqualify courtiers who are close to the ruler (ally/spouse/heir) or who
                # already hold claims on the ruler_root's kingdom+ titles.
                set_variable = { name = rf_disqualify value = 0 }
                # Close-relation checks (same as claimant checks)
                if = {
                    limit = {
                        OR = {
                            is_allied_to = root
                            is_spouse_of = root
                            is_heir_of = root
                            is_primary_heir_of = root
                            is_player_heir_of = root
                        }
                    }
                    set_variable = { name = rf_disqualify value = 1 }
                }

                # Check for claims on ruler_root's kingdom+ titles
                scope:ruler_root = {
                    every_held_title = {
                        limit = { tier >= tier_kingdom }
                        scope:adventurer_candidate = {
                            if = { limit = { has_claim_on = prev } set_variable = { name = rf_disqualify value = 1 } }
                        }
                    }
                }

                if = {
                    limit = { var:rf_disqualify == 0 }
                    scope:adventurer_candidate = {
                        add_unpressed_claim = scope:ruler_root.primary_title
                    }
                    if = { limit = { exists = scope:adventurer_candidate scope:adventurer_candidate = { is_alive = yes } } scope:adventurer_candidate = { riseandfall_do_create_adventurer_se = yes } }
                    # consume a courtier slot for a successful conscription
                    scope:ruler_root = { change_variable = { name = remaining_courtier_slots subtract = 1 } }
                    root = { change_variable = { name = remaining_courtier_slots subtract = 1 } }
                }
                else = {
                    # Disqualified courtiers still consume an attempt to avoid infinite loops
                    scope:ruler_root = { change_variable = { name = remaining_courtier_slots subtract = 1 } }
                    root = { change_variable = { name = remaining_courtier_slots subtract = 1 } }
                }
                remove_variable = rf_disqualify
            }
        }
        else = {
            set_variable = { name = no_more_courtiers value = 1 }
        }
    }
    clear_saved_scope = adventurer_candidate

    set_variable = { name = generated_to_create value = var:remaining_courtier_slots }
    set_variable = { name = no_more_courtiers value = 0 }

    # Handle generated characters if we still have open slots
    while = {
        limit = { var:generated_to_create > 0 }
        create_character = {
            location = root.capital_province
            culture = root.culture
            faith = root.faith
            age = { 16 40 }
            gender_female_chance = 50
            save_scope_as = adventurer_candidate
        }
        scope:adventurer_candidate = {
            add_unpressed_claim = scope:ruler_root.primary_title
        }
        if = { limit = { exists = scope:adventurer_candidate scope:adventurer_candidate = { is_alive = yes } } scope:adventurer_candidate = { riseandfall_do_create_adventurer_se = yes } }
        change_variable = { name = generated_to_create subtract = 1 }
    }

    clear_saved_scope = adventurer_candidate

    remove_variable = remaining_courtier_slots
    remove_variable = generated_to_create
    remove_variable = no_more_courtiers
    remove_variable = num_existing
    remove_variable = num_generated
    remove_variable = claimant_count
}