##########################
# Rise and Fall - Low Stability yearly roll
# Runs once per year from an on_action. For each ruler, compute chance = (100 - stability_score) * 0.05 (capped at 5%).
# If the random check succeeds, trigger an event (riseandfall.1001 - warlord).

riseandfall_low_stability_roll_se = {
    # For every independent ruler, compute chance once using the ruler's stability
    every_independent_ruler = {
        save_scope_as = independent_ruler

        # Perform computations inside the saved scope so scope:independent_ruler variables resolve correctly
        scope:independent_ruler = {
            # Ensure the ruler has a stability score; default to 100 if missing
            if = {
                limit = { NOT = { has_variable = riseandfall_realm_stability_score } }
                set_variable = { name = riseandfall_realm_stability_score value = 100 }
            }

            # Compute chance based on stability
            # Only trigger when stability is 30 or less.
            # Chance scales linearly: chance = 1 + ((30 - stability) * 99) / 30
            if = {
                limit = { check_variable = { which = riseandfall_realm_stability_score value > 30 } }
                set_variable = { name = tmp_chance value = 0 }
            }
            else = {
                # tmp_diff = 30 - stability
                set_variable = { name = tmp_diff value = 0 }
                change_variable = { name = tmp_diff add = var:riseandfall_realm_stability_score }
                change_variable = { name = tmp_diff multiply = -1 }
                change_variable = { name = tmp_diff add = 30 }

                # tmp_chance = (tmp_diff * 99) / 30 + 1
                set_variable = { name = tmp_chance value = 0 }
                change_variable = { name = tmp_chance add = var:tmp_diff }
                change_variable = { name = tmp_chance multiply = 99 }
                change_variable = { name = tmp_chance divide = 30 }
                change_variable = { name = tmp_chance add = 1 }
                clamp_variable = { name = tmp_chance min = 1 max = 100 }
            }

            # Roll once for the independent ruler. If it succeeds, notify the liege and add stability
            random = {
                chance = var:tmp_chance
                # Notify the liege (independent_ruler) that warlords are emerging
                trigger_event = { id = warlord.1001 }
            }
        }
    }
}
