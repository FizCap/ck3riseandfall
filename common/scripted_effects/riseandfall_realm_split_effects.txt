##########################
# Rise and Fall - Realm Split System
# Simple realm split: picks 1–10 vassals (dynamic by realm size) and assigns a portion of the realm's vassals to them,
# makes them independent tributaries. Root keeps the rest.
# Supports governments without powerful vassals (Celestial, Japanese, Administrative, Meritocratic, etc.)
# All governments use county-tier or above

##########################
# Main Realm Split Effect
# Called on the ruler who is being split

riseandfall_realm_split_se = {
    save_scope_as = original_ruler
    primary_title = { save_scope_as = original_primary }

    # Determine dynamic number of breakaways based on direct vassal count
    scope:original_ruler = {
        set_variable = { name = rf_direct_vassals value = 0 }
        every_vassal = {
            limit = {
                is_landed = yes
                primary_title.tier >= tier_county
                NOT = { primary_title.tier >= tier_empire }
            }
            scope:original_ruler = { change_variable = { name = rf_direct_vassals add = 1 } }
        }

        # Heuristics: base minimum 1; +1 max per 10 vassals, capped at 10
        if = {
            limit = { has_variable = rf_direct_vassals }
            if = { limit = { var:rf_direct_vassals >= 90 } set_variable = { name = rf_breakaway_count value = 10 } }
            else_if = { limit = { var:rf_direct_vassals >= 80 } set_variable = { name = rf_breakaway_count value = 9 } }
            else_if = { limit = { var:rf_direct_vassals >= 70 } set_variable = { name = rf_breakaway_count value = 8 } }
            else_if = { limit = { var:rf_direct_vassals >= 60 } set_variable = { name = rf_breakaway_count value = 7 } }
            else_if = { limit = { var:rf_direct_vassals >= 50 } set_variable = { name = rf_breakaway_count value = 6 } }
            else_if = { limit = { var:rf_direct_vassals >= 40 } set_variable = { name = rf_breakaway_count value = 5 } }
            else_if = { limit = { var:rf_direct_vassals >= 30 } set_variable = { name = rf_breakaway_count value = 4 } }
            else_if = { limit = { var:rf_direct_vassals >= 20 } set_variable = { name = rf_breakaway_count value = 3 } }
            else_if = { limit = { var:rf_direct_vassals >= 10 } set_variable = { name = rf_breakaway_count value = 2 } }
            else = { set_variable = { name = rf_breakaway_count value = 1 } }
        }
        else = { set_variable = { name = rf_breakaway_count value = 1 } }
    }

    # Hegemony special case: make all empire-tier vassals break away automatically
    if = {
        limit = { primary_title.tier = tier_hegemony }
        scope:original_ruler = {
            every_vassal = {
                limit = {
                    is_landed = yes
                    primary_title.tier >= tier_empire
                }
                add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                # Rivalry and cross-claims with original ruler
                scope:original_ruler = { add_unpressed_claim = this.primary_title }
                this = { add_unpressed_claim = scope:original_primary }
                if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:original_ruler } NOT = { has_relation_rival = scope:original_ruler } } this = { set_relation_rival = { target = scope:original_ruler reason = riseandfall_realmsplit_became_rival } } }
                if = { limit = { can_set_relation_rival_trigger = { CHARACTER = this } NOT = { has_relation_rival = this } } scope:original_ruler = { set_relation_rival = { target = this reason = riseandfall_realmsplit_became_rival } } }
                # Execute realm split for the empire vassal immediately
                this = { riseandfall_execute_realm_split_se = yes }
            }
        }
    }
    
    # Pick 1–10 vassals (dynamic by rf_breakaway_count) to become breakaway rulers

    # First breakaway ruler - strongest vassal (simplified)
    ordered_vassal = {
        limit = {
            is_landed = yes
            primary_title.tier >= tier_county
            NOT = { primary_title.tier >= tier_empire }
        }
        order_by = current_military_strength
        max = 1

        save_scope_as = breakaway_1
        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
    }
    
    # Second breakaway ruler
    if = {
        limit = { exists = scope:breakaway_1 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 2 }
                ordered_vassal = {
                    limit = {
                        is_landed = yes
                        primary_title.tier >= tier_county
                        NOT = { primary_title.tier >= tier_empire }
                        NOT = { this = scope:breakaway_1 }
                    }
                    order_by = current_military_strength
                    max = 1

                    save_scope_as = breakaway_2
                    add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                }
            }
        }
    }

    # Third breakaway ruler (50% chance)
    if = {
        limit = { exists = scope:breakaway_2 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 3 }
                random = {
                    chance = 50
                    if = {
                        ordered_vassal = {
                            limit = {
                                is_landed = yes
                                primary_title.tier >= tier_county
                                NOT = { primary_title.tier >= tier_empire }
                                NOT = { this = scope:breakaway_1 }
                                NOT = { this = scope:breakaway_2 }
                            }
                            order_by = current_military_strength
                            max = 1

                            save_scope_as = breakaway_3
                            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                        }
                    }
                    else = {
                        ordered_vassal = {
                            limit = {
                                is_landed = yes
                                primary_title.tier >= tier_county
                                NOT = { primary_title.tier >= tier_empire }
                                NOT = { this = scope:breakaway_1 }
                                NOT = { this = scope:breakaway_2 }
                            }
                            order_by = current_military_strength
                            max = 1

                            save_scope_as = breakaway_3
                            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                        }
                    }
                }
            }
        }
    }

    # Fourth breakaway ruler (25% chance, only if third exists)
    if = {
        limit = { exists = scope:breakaway_3 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 4 }
                random = {
                    chance = 25
                    if = {
                        ordered_vassal = {
                            limit = {
                                is_landed = yes
                                primary_title.tier >= tier_county
                                NOT = { primary_title.tier >= tier_empire }
                                NOT = { this = scope:breakaway_1 }
                                NOT = { this = scope:breakaway_2 }
                                NOT = { this = scope:breakaway_3 }
                            }
                            order_by = current_military_strength
                            max = 1

                            save_scope_as = breakaway_4
                            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                        }
                    }
                    else = {
                        ordered_vassal = {
                            limit = {
                                is_landed = yes
                                primary_title.tier >= tier_county
                                NOT = { primary_title.tier >= tier_empire }
                                NOT = { this = scope:breakaway_1 }
                                NOT = { this = scope:breakaway_2 }
                                NOT = { this = scope:breakaway_3 }
                            }
                            order_by = current_military_strength
                            max = 1

                            save_scope_as = breakaway_4
                            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                        }
                    }
                }
            }
        }
    }

    # Additional breakaway rulers (5-10). Each requires rf_breakaway_count >= N; chances decrease as N grows.
    if = {
        limit = { exists = scope:breakaway_4 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 5 }
                random = {
                    chance = 20
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_5
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    if = {
        limit = { exists = scope:breakaway_5 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 6 }
                random = {
                    chance = 15
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                            NOT = { this = scope:breakaway_5 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_6
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    if = {
        limit = { exists = scope:breakaway_6 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 7 }
                random = {
                    chance = 10
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                            NOT = { this = scope:breakaway_5 }
                            NOT = { this = scope:breakaway_6 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_7
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    if = {
        limit = { exists = scope:breakaway_7 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 8 }
                random = {
                    chance = 7
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                            NOT = { this = scope:breakaway_5 }
                            NOT = { this = scope:breakaway_6 }
                            NOT = { this = scope:breakaway_7 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_8
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    if = {
        limit = { exists = scope:breakaway_8 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 9 }
                random = {
                    chance = 5
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                            NOT = { this = scope:breakaway_5 }
                            NOT = { this = scope:breakaway_6 }
                            NOT = { this = scope:breakaway_7 }
                            NOT = { this = scope:breakaway_8 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_9
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    if = {
        limit = { exists = scope:breakaway_9 }
        if = {
            limit = { has_variable = rf_breakaway_count }
            if = {
                limit = { var:rf_breakaway_count >= 10 }
                random = {
                    chance = 3
                    ordered_vassal = {
                        limit = {
                            is_landed = yes
                            primary_title.tier >= tier_county
                            NOT = { primary_title.tier >= tier_empire }
                            NOT = { this = scope:breakaway_1 }
                            NOT = { this = scope:breakaway_2 }
                            NOT = { this = scope:breakaway_3 }
                            NOT = { this = scope:breakaway_4 }
                            NOT = { this = scope:breakaway_5 }
                            NOT = { this = scope:breakaway_6 }
                            NOT = { this = scope:breakaway_7 }
                            NOT = { this = scope:breakaway_8 }
                            NOT = { this = scope:breakaway_9 }
                        }
                        order_by = current_military_strength
                        max = 1

                        save_scope_as = breakaway_10
                        add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                    }
                }
            }
        }
    }

    # Assign vassals based on geographic proximity using de_jure territories
    # Vassals prefer to join breakaway rulers in the same de_jure kingdom/empire
    every_vassal = {
        limit = {
            is_landed = yes
            NOT = { has_character_flag = rf_breakaway_ruler }
            primary_title.tier >= tier_county
            NOT = { primary_title.tier >= tier_empire }
        }
        
        # Use weighted random - higher weight for same de_jure territory
        # Geography-first assignment: duchy (+400) > kingdom (+250) > adjacency (+200) > empire (+75)
        # Culture match (+50) promotes cohesive realms; penalty for distant assignments (-30)
        random_list = {
            # Stay with root (base weight reduced to prefer breakaways)
            30 = {
                modifier = {
                    add = 50
                    capital_county = {
                        any_this_title_or_de_jure_above = {
                            this = scope:original_ruler.capital_county
                        }
                    }
                }
                modifier = {
                    add = 150
                    capital_county.kingdom = scope:original_ruler.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:original_ruler }
                }
                modifier = {
                    add = 50
                    culture = scope:original_ruler.culture
                }
            }
            # Join breakaway_1
            50 = {
                trigger = { exists = scope:breakaway_1 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_1.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_1.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_1 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_1.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_1.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_1.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_1 }
            }
            # Join breakaway_2
            50 = {
                trigger = { exists = scope:breakaway_2 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_2.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_2.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_2 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_2.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_2.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_2.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_2 }
            }
            # Join breakaway_3
            50 = {
                trigger = { exists = scope:breakaway_3 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_3.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_3.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_3 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_3.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_3.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_3.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_3 }
            }
            # Join breakaway_4
            50 = {
                trigger = { exists = scope:breakaway_4 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_4.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_4.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_4 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_4.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_4.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_4.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_4 }
            }
            # Join breakaway_5
            50 = {
                trigger = { exists = scope:breakaway_5 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_5.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_5.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_5 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_5.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_5.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_5.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_5 }
            }
            # Join breakaway_6
            50 = {
                trigger = { exists = scope:breakaway_6 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_6.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_6.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_6 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_6.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_6.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_6.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_6 }
            }
            # Join breakaway_7
            50 = {
                trigger = { exists = scope:breakaway_7 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_7.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_7.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_7 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_7.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_7.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_7.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_7 }
            }
            # Join breakaway_8
            50 = {
                trigger = { exists = scope:breakaway_8 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_8.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_8.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_8 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_8.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_8.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_8.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_8 }
            }
            # Join breakaway_9
            50 = {
                trigger = { exists = scope:breakaway_9 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_9.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_9.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_9 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_9.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_9.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_9.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_9 }
            }
            # Join breakaway_10
            50 = {
                trigger = { exists = scope:breakaway_10 }
                modifier = {
                    add = 400
                    capital_county.duchy = scope:breakaway_10.capital_county.duchy
                }
                modifier = {
                    add = 250
                    capital_county.kingdom = scope:breakaway_10.capital_county.kingdom
                }
                modifier = {
                    add = 200
                    primary_title = { is_neighbor_to_realm = scope:breakaway_10 }
                }
                modifier = {
                    add = 75
                    capital_county.empire = scope:breakaway_10.capital_county.empire
                }
                modifier = {
                    add = 50
                    culture = scope:breakaway_10.culture
                }
                modifier = {
                    add = -30
                    NOT = { capital_county.empire = scope:breakaway_10.capital_county.empire }
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_10 }
            }
        }
    }
    
    # Set rivalries and claims between breakaways and original ruler
    if = {
        limit = { exists = scope:breakaway_1 }
        # Rivalry and claims with original
        scope:breakaway_1 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:original_ruler } NOT = { has_relation_rival = scope:original_ruler } } set_relation_rival = { target = scope:original_ruler reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_1 } NOT = { has_relation_rival = scope:breakaway_1 } } set_relation_rival = { target = scope:breakaway_1 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = { add_unpressed_claim = scope:breakaway_1.primary_title }
        scope:breakaway_1 = { add_unpressed_claim = scope:original_primary }
    }
    if = {
        limit = { exists = scope:breakaway_2 }
        # Rivalry and claims with original
        scope:breakaway_2 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:original_ruler } NOT = { has_relation_rival = scope:original_ruler } } set_relation_rival = { target = scope:original_ruler reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_2 } NOT = { has_relation_rival = scope:breakaway_2 } } set_relation_rival = { target = scope:breakaway_2 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = { add_unpressed_claim = scope:breakaway_2.primary_title }
        scope:breakaway_2 = { add_unpressed_claim = scope:original_primary }
        # Rivalry and claims with breakaway_1
        scope:breakaway_2 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_1 } NOT = { has_relation_rival = scope:breakaway_1 } } set_relation_rival = { target = scope:breakaway_1 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_2 } NOT = { has_relation_rival = scope:breakaway_2 } } set_relation_rival = { target = scope:breakaway_2 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = { add_unpressed_claim = scope:breakaway_2.primary_title }
        scope:breakaway_2 = { add_unpressed_claim = scope:breakaway_1.primary_title }
    }
    if = {
        limit = { exists = scope:breakaway_3 }
        # Rivalry and claims with original
        scope:breakaway_3 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:original_ruler } NOT = { has_relation_rival = scope:original_ruler } } set_relation_rival = { target = scope:original_ruler reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_3 } NOT = { has_relation_rival = scope:breakaway_3 } } set_relation_rival = { target = scope:breakaway_3 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = { add_unpressed_claim = scope:breakaway_3.primary_title }
        scope:breakaway_3 = { add_unpressed_claim = scope:original_primary }
        # Rivalry and claims with breakaway_1
        scope:breakaway_3 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_1 } NOT = { has_relation_rival = scope:breakaway_1 } } set_relation_rival = { target = scope:breakaway_1 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_3 } NOT = { has_relation_rival = scope:breakaway_3 } } set_relation_rival = { target = scope:breakaway_3 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = { add_unpressed_claim = scope:breakaway_3.primary_title }
        scope:breakaway_3 = { add_unpressed_claim = scope:breakaway_1.primary_title }
        # Rivalry and claims with breakaway_2
        scope:breakaway_3 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_2 } NOT = { has_relation_rival = scope:breakaway_2 } } set_relation_rival = { target = scope:breakaway_2 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_2 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_3 } NOT = { has_relation_rival = scope:breakaway_3 } } set_relation_rival = { target = scope:breakaway_3 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_2 = { add_unpressed_claim = scope:breakaway_3.primary_title }
        scope:breakaway_3 = { add_unpressed_claim = scope:breakaway_2.primary_title }
    }
    if = {
        limit = { exists = scope:breakaway_4 }
        # Rivalry and claims with original
        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:original_ruler } NOT = { has_relation_rival = scope:original_ruler } } set_relation_rival = { target = scope:original_ruler reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:original_ruler = { add_unpressed_claim = scope:breakaway_4.primary_title }
        scope:breakaway_4 = { add_unpressed_claim = scope:original_primary }
        # Rivalry and claims with breakaway_1
        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_1 } NOT = { has_relation_rival = scope:breakaway_1 } } set_relation_rival = { target = scope:breakaway_1 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_1 = { add_unpressed_claim = scope:breakaway_4.primary_title }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_1.primary_title }
        # Rivalry and claims with breakaway_2
        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_2 } NOT = { has_relation_rival = scope:breakaway_2 } } set_relation_rival = { target = scope:breakaway_2 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_2 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_2 = { add_unpressed_claim = scope:breakaway_4.primary_title }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_2.primary_title }
        # Rivalry and claims with breakaway_3
        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_3 } NOT = { has_relation_rival = scope:breakaway_3 } } set_relation_rival = { target = scope:breakaway_3 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_3 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_3 = { add_unpressed_claim = scope:breakaway_4.primary_title }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_3.primary_title }
        # Rivalry and claims with breakaway_5..10 (pairwise additions)
        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_5 } NOT = { has_relation_rival = scope:breakaway_5 } } set_relation_rival = { target = scope:breakaway_5 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_5 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_5.primary_title }
        scope:breakaway_5 = { add_unpressed_claim = scope:breakaway_4.primary_title }

        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_6 } NOT = { has_relation_rival = scope:breakaway_6 } } set_relation_rival = { target = scope:breakaway_6 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_6 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_6.primary_title }
        scope:breakaway_6 = { add_unpressed_claim = scope:breakaway_4.primary_title }

        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_7 } NOT = { has_relation_rival = scope:breakaway_7 } } set_relation_rival = { target = scope:breakaway_7 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_7 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_7.primary_title }
        scope:breakaway_7 = { add_unpressed_claim = scope:breakaway_4.primary_title }

        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_8 } NOT = { has_relation_rival = scope:breakaway_8 } } set_relation_rival = { target = scope:breakaway_8 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_8 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_8.primary_title }
        scope:breakaway_8 = { add_unpressed_claim = scope:breakaway_4.primary_title }

        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_9 } NOT = { has_relation_rival = scope:breakaway_9 } } set_relation_rival = { target = scope:breakaway_9 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_9 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_9.primary_title }
        scope:breakaway_9 = { add_unpressed_claim = scope:breakaway_4.primary_title }

        scope:breakaway_4 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_10 } NOT = { has_relation_rival = scope:breakaway_10 } } set_relation_rival = { target = scope:breakaway_10 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_10 = {
            if = { limit = { can_set_relation_rival_trigger = { CHARACTER = scope:breakaway_4 } NOT = { has_relation_rival = scope:breakaway_4 } } set_relation_rival = { target = scope:breakaway_4 reason = riseandfall_realmsplit_became_rival } }
        }
        scope:breakaway_4 = { add_unpressed_claim = scope:breakaway_10.primary_title }
        scope:breakaway_10 = { add_unpressed_claim = scope:breakaway_4.primary_title }
    }
    
    # Execute the splits for each breakaway ruler
    if = {
        limit = { exists = scope:breakaway_1 }
        scope:breakaway_1 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_2 }
        scope:breakaway_2 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_3 }
        scope:breakaway_3 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_4 }
        scope:breakaway_4 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_5 }
        scope:breakaway_5 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_6 }
        scope:breakaway_6 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_7 }
        scope:breakaway_7 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_8 }
        scope:breakaway_8 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_9 }
        scope:breakaway_9 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_10 }
        scope:breakaway_10 = { riseandfall_execute_realm_split_se = yes }
    }
    
    # Cleanup flags
    every_vassal = {
        limit = { has_character_flag = rf_breakaway_ruler }
        remove_character_flag = rf_breakaway_ruler
    }

    # Cleanup temporary variables and add cooldown
    scope:original_ruler = {
        remove_variable = rf_direct_vassals
        remove_variable = rf_breakaway_count
    }
    set_variable = { name = rf_realm_split_cooldown value = 1 years = 5 }
}

##########################
# Execute Realm Split
# Called on a breakaway ruler - makes them independent with their assigned vassals

riseandfall_execute_realm_split_se = {
    save_scope_as = new_realm_ruler
    
    # Pick a random naming style: 1 = Capital name, 2 = Ruler name
    random_list = {
        50 = { set_variable = { name = rf_title_style value = 1 } } # Capital name (e.g. "Constantinople Domain")
        50 = { set_variable = { name = rf_title_style value = 2 } } # Ruler name (e.g. "Li's Realm")
    }
    
    # Create the new realm title
    # Note: Hegemony tier cannot have dynamic titles, so treat it as empire
    scope:original_ruler = {
        primary_title = {
            if = {
                limit = {
                    OR = {
                        tier = tier_empire
                        tier = tier_hegemony
                    }
                }
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }

                    # If the breakaway already holds an empire-tier primary title, use it
                    if = {
                        limit = { scope:rf_breakaway_ruler.primary_title.tier >= tier_empire }
                        scope:rf_breakaway_ruler = {
                            primary_title = {
                                save_scope_as = rf_new_title
                                set_color_from_title = scope:rf_base_county
                                # Set coat of arms from dynasty if ruler has one
                                if = {
                                    limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                    set_coa = scope:rf_breakaway_ruler.dynasty
                                }
                            }
                        }
                    }
                    else = {
                        if = {
                            limit = {
                                has_variable = rf_title_style
                                var:rf_title_style = 1
                            }
                            create_dynamic_title = {
                                tier = empire
                                name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                            }
                        }
                        else = {
                            create_dynamic_title = {
                                tier = empire
                                name = RISEANDFALL_BREAKAWAY_NAME_RULER
                            }
                        }
                        if = {
                            limit = { exists = scope:new_title }
                            scope:new_title = {
                                save_scope_as = rf_new_title
                                set_color_from_title = scope:rf_base_county
                                # Set coat of arms from dynasty if ruler has one
                                if = {
                                    limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                    set_coa = scope:rf_breakaway_ruler.dynasty
                                }
                            }
                        }
                    }
                }
            }
            else_if = {
                limit = { tier = tier_kingdom }
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }
                    if = {
                        limit = {
                            has_variable = rf_title_style
                            var:rf_title_style = 1
                        }
                        create_dynamic_title = {
                            tier = kingdom
                            name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                        }
                    }
                    else = {
                        create_dynamic_title = {
                            tier = kingdom
                            name = RISEANDFALL_BREAKAWAY_NAME_RULER
                        }
                    }
                    if = {
                        limit = { exists = scope:new_title }
                        scope:new_title = {
                            save_scope_as = rf_new_title
                            set_color_from_title = scope:rf_base_county
                            # Set coat of arms from dynasty if ruler has one
                            if = {
                                limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                set_coa = scope:rf_breakaway_ruler.dynasty
                            }
                        }
                    }
                }
            }
            else = {
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }
                    if = {
                        limit = {
                            has_variable = rf_title_style
                            var:rf_title_style = 1
                        }
                        create_dynamic_title = {
                            tier = duchy
                            name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                        }
                    }
                    else = {
                        create_dynamic_title = {
                            tier = duchy
                            name = RISEANDFALL_BREAKAWAY_NAME_RULER
                        }
                    }
                    if = {
                        limit = { exists = scope:new_title }
                        scope:new_title = {
                            save_scope_as = rf_new_title
                            set_color_from_title = scope:rf_base_county
                            # Set coat of arms from dynasty if ruler has one
                            if = {
                                limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                set_coa = scope:rf_breakaway_ruler.dynasty
                            }
                        }
                    }
                }
            }
        }
    }
    
    # Cleanup the style variable
    remove_variable = rf_title_style
    
    # Give them the new title
    if = {
        limit = { exists = scope:rf_new_title }
        create_title_and_vassal_change = {
            type = created
            save_scope_as = rf_title_change
            add_claim_on_loss = yes
        }
        scope:rf_new_title = {
            change_title_holder = {
                holder = scope:new_realm_ruler
                change = scope:rf_title_change
            }
        }
        resolve_title_and_vassal_change = scope:rf_title_change
    }
    
    # Transfer assigned vassals
    create_title_and_vassal_change = {
        type = conquest
        save_scope_as = rf_vassal_change
        add_claim_on_loss = no
    }
    
    scope:original_ruler = {
        every_vassal = {
            limit = {
                has_variable = rf_my_breakaway
                var:rf_my_breakaway = scope:new_realm_ruler
            }
            change_liege = {
                liege = scope:new_realm_ruler
                change = scope:rf_vassal_change
            }
            remove_variable = rf_my_breakaway
        }
    }
    
    resolve_title_and_vassal_change = scope:rf_vassal_change
    
    # Make independent
    create_title_and_vassal_change = {
        type = independency
        save_scope_as = rf_indep_change
        add_claim_on_loss = yes
    }
    
    becomes_independent = {
        change = scope:rf_indep_change
    }
    
    resolve_title_and_vassal_change = scope:rf_indep_change
    
    # Make tributary of original ruler
    start_tributary = {
        contract_group = tributary_settled
        suzerain = scope:original_ruler
    }

    # Add claim on original primary title
    # If the original primary was a hegemon, ensure the original ruler
    # gets an unpressed claim on the breakaway's (possibly newly-created)
    # empire title so the hegemon can press for it later.
    if = {
        limit = { scope:original_primary.tier = tier_hegemony }
        if = { limit = { exists = scope:rf_new_title } scope:original_ruler = { add_unpressed_claim = scope:rf_new_title } }
        else = { if = { limit = { exists = scope:new_realm_ruler.primary_title } scope:original_ruler = { add_unpressed_claim = scope:new_realm_ruler.primary_title } } }
    }

    add_unpressed_claim = scope:original_primary


    # --- End new rivalry & cross-claims block ---

    # Remove flag
    remove_character_flag = rf_breakaway_ruler
}
