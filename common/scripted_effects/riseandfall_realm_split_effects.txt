##########################
# Rise and Fall - Realm Split System
# Simple realm split: picks 2-4 vassals, gives them ~half the realm's vassals,
# makes them independent tributaries. Root keeps the rest.
# Supports governments without powerful vassals (Celestial, Japanese, Administrative, Meritocratic, etc.)
# All governments use county-tier or above

##########################
# Main Realm Split Effect
# Called on the ruler who is being split

riseandfall_realm_split_se = {
    save_scope_as = original_ruler
    primary_title = { save_scope_as = original_primary }
    
    # Pick 2-4 vassals to become breakaway rulers
    # Use ordered_vassal for governments without powerful vassals, ordered_powerful_vassal otherwise
    
    # First breakaway ruler - strongest vassal
    if = {
        limit = { riseandfall_no_powerful_vassals_trigger = yes }
        # Administrative governments - use ordered_vassal
        ordered_vassal = {
            limit = {
                is_landed = yes
                primary_title.tier >= tier_county
            }
            order_by = current_military_strength
            max = 1
            
            save_scope_as = breakaway_1
            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
        }
    }
    else = {
        # Feudal/Clan - use powerful vassals
        ordered_powerful_vassal = {
            limit = {
                is_landed = yes
                primary_title.tier >= tier_county
            }
            order_by = current_military_strength
            max = 1
            
            save_scope_as = breakaway_1
            add_character_flag = { flag = rf_breakaway_ruler days = 30 }
        }
    }
    
    # Second breakaway ruler
    if = {
        limit = { exists = scope:breakaway_1 }
        if = {
            limit = { riseandfall_no_powerful_vassals_trigger = yes }
            ordered_vassal = {
                limit = {
                    is_landed = yes
                    primary_title.tier >= tier_county
                    NOT = { this = scope:breakaway_1 }
                }
                order_by = current_military_strength
                max = 1
                
                save_scope_as = breakaway_2
                add_character_flag = { flag = rf_breakaway_ruler days = 30 }
            }
        }
        else = {
            ordered_powerful_vassal = {
                limit = {
                    is_landed = yes
                    primary_title.tier >= tier_county
                    NOT = { this = scope:breakaway_1 }
                }
                order_by = current_military_strength
                max = 1
                
                save_scope_as = breakaway_2
                add_character_flag = { flag = rf_breakaway_ruler days = 30 }
            }
        }
    }
    
    # Third breakaway ruler (50% chance)
    if = {
        limit = { exists = scope:breakaway_2 }
        random = {
            chance = 50
            if = {
                limit = { riseandfall_no_powerful_vassals_trigger = yes }
                ordered_vassal = {
                    limit = {
                        is_landed = yes
                        primary_title.tier >= tier_county
                        NOT = { this = scope:breakaway_1 }
                        NOT = { this = scope:breakaway_2 }
                    }
                    order_by = current_military_strength
                    max = 1
                    
                    save_scope_as = breakaway_3
                    add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                }
            }
            else = {
                ordered_powerful_vassal = {
                    limit = {
                        is_landed = yes
                        primary_title.tier >= tier_county
                        NOT = { this = scope:breakaway_1 }
                        NOT = { this = scope:breakaway_2 }
                    }
                    order_by = current_military_strength
                    max = 1
                    
                    save_scope_as = breakaway_3
                    add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                }
            }
        }
    }
    
    # Fourth breakaway ruler (25% chance, only if third exists)
    if = {
        limit = { exists = scope:breakaway_3 }
        random = {
            chance = 25
            if = {
                limit = { riseandfall_no_powerful_vassals_trigger = yes }
                ordered_vassal = {
                    limit = {
                        is_landed = yes
                        primary_title.tier >= tier_county
                        NOT = { this = scope:breakaway_1 }
                        NOT = { this = scope:breakaway_2 }
                        NOT = { this = scope:breakaway_3 }
                    }
                    order_by = current_military_strength
                    max = 1
                    
                    save_scope_as = breakaway_4
                    add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                }
            }
            else = {
                ordered_powerful_vassal = {
                    limit = {
                        is_landed = yes
                        primary_title.tier >= tier_county
                        NOT = { this = scope:breakaway_1 }
                        NOT = { this = scope:breakaway_2 }
                        NOT = { this = scope:breakaway_3 }
                    }
                    order_by = current_military_strength
                    max = 1
                    
                    save_scope_as = breakaway_4
                    add_character_flag = { flag = rf_breakaway_ruler days = 30 }
                }
            }
        }
    }
    
    # Assign vassals based on geographic proximity using de_jure territories
    # Vassals prefer to join breakaway rulers in the same de_jure kingdom/empire
    every_vassal = {
        limit = {
            is_landed = yes
            NOT = { has_character_flag = rf_breakaway_ruler }
            primary_title.tier >= tier_county
        }
        
        # Use weighted random - higher weight for same de_jure territory
        # Base weight 10, bonus 100 if same de_jure kingdom
        random_list = {
            # Stay with root (low base chance)
            10 = {
                modifier = {
                    add = 50
                    capital_county = {
                        any_this_title_or_de_jure_above = {
                            this = scope:original_ruler.capital_county
                        }
                    }
                }
                modifier = {
                    add = 100
                    capital_county.kingdom = scope:original_ruler.capital_county.kingdom
                }
            }
            # Join breakaway_1
            100 = {
                trigger = { exists = scope:breakaway_1 }
                modifier = {
                    add = 200
                    capital_county.kingdom = scope:breakaway_1.capital_county.kingdom
                }
                modifier = {
                    add = 100
                    capital_county.duchy = scope:breakaway_1.capital_county.duchy
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_1 }
            }
            # Join breakaway_2
            100 = {
                trigger = { exists = scope:breakaway_2 }
                modifier = {
                    add = 200
                    capital_county.kingdom = scope:breakaway_2.capital_county.kingdom
                }
                modifier = {
                    add = 100
                    capital_county.duchy = scope:breakaway_2.capital_county.duchy
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_2 }
            }
            # Join breakaway_3
            100 = {
                trigger = { exists = scope:breakaway_3 }
                modifier = {
                    add = 200
                    capital_county.kingdom = scope:breakaway_3.capital_county.kingdom
                }
                modifier = {
                    add = 100
                    capital_county.duchy = scope:breakaway_3.capital_county.duchy
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_3 }
            }
            # Join breakaway_4
            100 = {
                trigger = { exists = scope:breakaway_4 }
                modifier = {
                    add = 200
                    capital_county.kingdom = scope:breakaway_4.capital_county.kingdom
                }
                modifier = {
                    add = 100
                    capital_county.duchy = scope:breakaway_4.capital_county.duchy
                }
                set_variable = { name = rf_my_breakaway value = scope:breakaway_4 }
            }
        }
    }
    
    # Execute the splits for each breakaway ruler
    if = {
        limit = { exists = scope:breakaway_1 }
        scope:breakaway_1 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_2 }
        scope:breakaway_2 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_3 }
        scope:breakaway_3 = { riseandfall_execute_realm_split_se = yes }
    }
    if = {
        limit = { exists = scope:breakaway_4 }
        scope:breakaway_4 = { riseandfall_execute_realm_split_se = yes }
    }
    
    # Cleanup flags
    every_vassal = {
        limit = { has_character_flag = rf_breakaway_ruler }
        remove_character_flag = rf_breakaway_ruler
    }
    
    # Add cooldown
    set_variable = { name = rf_realm_split_cooldown value = 1 years = 5 }
}

##########################
# Execute Realm Split
# Called on a breakaway ruler - makes them independent with their assigned vassals

riseandfall_execute_realm_split_se = {
    save_scope_as = new_realm_ruler
    
    # Pick a random naming style: 1 = Capital name, 2 = Ruler name
    random_list = {
        50 = { set_variable = { name = rf_title_style value = 1 } } # Capital name (e.g. "Constantinople Domain")
        50 = { set_variable = { name = rf_title_style value = 2 } } # Ruler name (e.g. "Li's Realm")
    }
    
    # Create the new realm title
    # Note: Hegemony tier cannot have dynamic titles, so treat it as empire
    scope:original_ruler = {
        primary_title = {
            if = {
                limit = {
                    OR = {
                        tier = tier_empire
                        tier = tier_hegemony
                    }
                }
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }
                    if = {
                        limit = {
                            has_variable = rf_title_style
                            var:rf_title_style = 1
                        }
                        create_dynamic_title = {
                            tier = empire
                            name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                        }
                    }
                    else = {
                        create_dynamic_title = {
                            tier = empire
                            name = RISEANDFALL_BREAKAWAY_NAME_RULER
                        }
                    }
                    if = {
                        limit = { exists = scope:new_title }
                        scope:new_title = {
                            save_scope_as = rf_new_title
                            set_color_from_title = scope:rf_base_county
                            # Set coat of arms from dynasty if ruler has one
                            if = {
                                limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                set_coa = scope:rf_breakaway_ruler.dynasty
                            }
                        }
                    }
                }
            }
            else_if = {
                limit = { tier = tier_kingdom }
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }
                    if = {
                        limit = {
                            has_variable = rf_title_style
                            var:rf_title_style = 1
                        }
                        create_dynamic_title = {
                            tier = kingdom
                            name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                        }
                    }
                    else = {
                        create_dynamic_title = {
                            tier = kingdom
                            name = RISEANDFALL_BREAKAWAY_NAME_RULER
                        }
                    }
                    if = {
                        limit = { exists = scope:new_title }
                        scope:new_title = {
                            save_scope_as = rf_new_title
                            set_color_from_title = scope:rf_base_county
                            # Set coat of arms from dynasty if ruler has one
                            if = {
                                limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                set_coa = scope:rf_breakaway_ruler.dynasty
                            }
                        }
                    }
                }
            }
            else = {
                scope:new_realm_ruler = {
                    save_scope_as = rf_breakaway_ruler
                    capital_county = { save_scope_as = rf_base_county }
                    capital_province = { save_scope_as = rf_base_province }
                    if = {
                        limit = {
                            has_variable = rf_title_style
                            var:rf_title_style = 1
                        }
                        create_dynamic_title = {
                            tier = duchy
                            name = RISEANDFALL_BREAKAWAY_NAME_CAPITAL
                        }
                    }
                    else = {
                        create_dynamic_title = {
                            tier = duchy
                            name = RISEANDFALL_BREAKAWAY_NAME_RULER
                        }
                    }
                    if = {
                        limit = { exists = scope:new_title }
                        scope:new_title = {
                            save_scope_as = rf_new_title
                            set_color_from_title = scope:rf_base_county
                            # Set coat of arms from dynasty if ruler has one
                            if = {
                                limit = { scope:rf_breakaway_ruler = { has_dynasty = yes } }
                                set_coa = scope:rf_breakaway_ruler.dynasty
                            }
                        }
                    }
                }
            }
        }
    }
    
    # Cleanup the style variable
    remove_variable = rf_title_style
    
    # Give them the new title
    if = {
        limit = { exists = scope:rf_new_title }
        create_title_and_vassal_change = {
            type = created
            save_scope_as = rf_title_change
            add_claim_on_loss = yes
        }
        scope:rf_new_title = {
            change_title_holder = {
                holder = scope:new_realm_ruler
                change = scope:rf_title_change
            }
        }
        resolve_title_and_vassal_change = scope:rf_title_change
    }
    
    # Transfer assigned vassals
    create_title_and_vassal_change = {
        type = conquest
        save_scope_as = rf_vassal_change
        add_claim_on_loss = no
    }
    
    scope:original_ruler = {
        every_vassal = {
            limit = {
                has_variable = rf_my_breakaway
                var:rf_my_breakaway = scope:new_realm_ruler
            }
            change_liege = {
                liege = scope:new_realm_ruler
                change = scope:rf_vassal_change
            }
            remove_variable = rf_my_breakaway
        }
    }
    
    resolve_title_and_vassal_change = scope:rf_vassal_change
    
    # Make independent
    create_title_and_vassal_change = {
        type = independency
        save_scope_as = rf_indep_change
        add_claim_on_loss = yes
    }
    
    becomes_independent = {
        change = scope:rf_indep_change
    }
    
    resolve_title_and_vassal_change = scope:rf_indep_change
    
    # Make tributary of original ruler
    start_tributary = {
        contract_group = tributary_settled
        suzerain = scope:original_ruler
    }
    
    # Add truce
    add_truce_both_ways = {
        character = scope:original_ruler
        years = 10
        name = RISEANDFALL_REALM_SPLIT_TRUCE
    }
    
    # Add claim on original primary title
    add_unpressed_claim = scope:original_primary
    
    # Remove flag
    remove_character_flag = rf_breakaway_ruler
}
