##########################
# Rise and Fall - Low Stability Events Scripted Effects
# Contains scripted effects related to low stability events
# Sets up the challenger selection, kills courtiers, creates adventurer title, and sets cooldowns

riseandfall_palace_coup_setup = {
	root = {
		every_held_title = {
			add_to_list = lost_titles
		}
	}
	# Save the event's root scope under a stable name for cross-scope variable access
	root = { save_scope_as = event_root }

	# Initialize best challenger score on the saved event_root scope so
	# comparisons using var:tmp_best_challenger_score are always valid
	scope:event_root = { set_variable = { name = tmp_best_challenger_score value = -9999 } }

	# Save root's primary title (if any) into a temporary title scope so
	# has_claim_on checks never receive a null title (engine validation fails)
	if = {
		limit = { root = { primary_title = { exists = yes } } }
		root = { primary_title = { save_scope_as = tmp_primary_title } }
	}
	# Select challenger preferring the courtier with the highest total stats
	# (Diplomacy + Martial + Stewardship + Intrigue + Learning).
	root = {
		every_courtier_or_guest = {
			limit = {
				is_alive = yes
				NOT = { is_close_family_of = root }
				age > 16
			}
			# Initialize candidate score from stats
			set_variable = { name = candidate_total value = diplomacy }
			change_variable = { name = candidate_total add = martial }
			change_variable = { name = candidate_total add = stewardship }
			change_variable = { name = candidate_total add = intrigue }
			change_variable = { name = candidate_total add = learning }

			# Apply realm succession law penalties (if not eligible, penalize heavily)
			if = { limit = { root = { has_realm_law = female_preference_law } } 
				if = { limit = { NOT = { is_female = yes } } change_variable = { name = candidate_total add = -1000 } }
			}
			if = { limit = { root = { has_realm_law = male_only_law } } 
				if = { limit = { NOT = { is_male = yes } } set_variable = { name = candidate_total value = -9999 } }
			}
			# Penalize female candidates in male-preference realms so males are preferred
			if = { limit = { root = { has_realm_law = male_preference_law } }
				if = { limit = { NOT = { is_male = yes } } change_variable = { name = candidate_total add = -1000 } }
			}
			if = { limit = { root = { has_realm_law = female_only_law } } 
				if = { limit = { NOT = { is_female = yes } } set_variable = { name = candidate_total value = -9999 } }
			}

			# If the root had a primary title saved above, give a multiplier to candidates who hold a claim
			if = { limit = { scope:tmp_primary_title = { exists = yes } } 
				if = { limit = { has_claim_on = scope:tmp_primary_title } change_variable = { name = candidate_total multiply = 1.5 } }
			}

			# Knights get a 1.5x multiplier
			if = { limit = { is_knight = yes } change_variable = { name = candidate_total multiply = 1.5 } }

			# Save candidate score to event_root and update best challenger if applicable
			save_scope_as = candidate_for_score
			scope:event_root = { set_variable = { name = tmp_candidate value = scope:candidate_for_score.var:candidate_total } }
			if = { limit = { scope:event_root = { has_variable = tmp_candidate } } 
				if = { limit = { scope:event_root.var:tmp_candidate > scope:event_root.var:tmp_best_challenger_score } 
					save_scope_as = challenger
					scope:event_root = { set_variable = { name = tmp_best_challenger_score value = scope:event_root.var:tmp_candidate } }
				}
			}
			}
	}
	if = {
		limit = { NOT = { exists = scope:challenger } }
		# Fallback challenger selection also respects male/female-only succession laws
		if = {
			limit = { root = { OR = { has_realm_law = male_only_law has_realm_law = male_preference_law } } }
			random_courtier = {
				limit = {
					is_landed = no
					is_alive = yes
					NOT = { is_close_family_of = root }
					age > 16
					is_male = yes
				}
				save_scope_as = challenger
			}
		}
		else_if = {
			limit = { root = { OR = { has_realm_law = female_only_law has_realm_law = female_preference_law } } }
			random_courtier = {
				limit = {
					is_landed = no
					is_alive = yes
					NOT = { is_close_family_of = root }
					age > 16
					is_female = yes
				}
				save_scope_as = challenger
			}
		}
		else = {
			random_courtier = {
				limit = {
					is_landed = no
					is_alive = yes
					NOT = { is_close_family_of = root }
					age > 16
				}
				save_scope_as = challenger
			}
		}
	}

	# Last-resort: if no challenger found yet, pick any alive courtier (including landed)
	if = {
		limit = { NOT = { exists = scope:challenger } }
		root = {
			random_courtier = {
				limit = { is_adult = yes }
				save_scope_as = challenger
			}
		}
	}

	if = {
		limit = { exists = scope:challenger }

		# Create a temporary landless adventurer camp for the challenger early
		# so the challenger has a title before we set employer relationships.
		if = {
			limit = { exists = scope:challenger }
			scope:challenger = {
				if = {
					limit = { is_alive = yes }
					create_adventurer_title = {
						name = palace_coup_adventurer_camp_name
						holder = scope:challenger
						government = landless_adventurer_government
						save_scope_as = palace_coup_challenger_camp_title
					}
					# Mark that we created the title
					scope:palace_coup_challenger_camp_title = {
						set_variable = { name = riseandfall_created_adventurer_title value = yes }
					}
				}
			}
			# Set a flag on event_root to indicate the camp was created
			scope:event_root = { set_variable = { name = challenger_camp_created value = yes } }
		}

		# If any claimant has a child who is present in root's court (a child),
		# install that child as the nominal ruler and make the challenger the
		# puppet master. We protect the child by making them employed by
		# the challenger (employer) so they won't be killed during the purge.
		# This scans courtiers for children whose parent has a claim on the
		# saved primary title (`tmp_primary_title`). Stops after the first match.
		if = {
			limit = { scope:tmp_primary_title = { exists = yes } }
			# Priority 1: prefer any child of the root that is present in the court
			scope:event_root = {
				every_courtier_or_guest = {
					limit = { NOT = { scope:event_root = { has_variable = installed_child_found } } NOT = { is_adult = yes } is_child_of = root }
					# Install the first matching child of the root
					save_scope_as = installed_child
					# record we found one to avoid multiple installations
					scope:event_root = { set_variable = { name = installed_child_found value = yes } }

					# If we already selected a challenger, make the child employed by them
					if = { limit = { scope:event_root = { has_variable = challenger_camp_created } } 
						if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } 
							set_employer = scope:challenger }
					}
				}
				# Priority 2: otherwise fall back to children whose parent holds a claim
				every_courtier_or_guest = {
					limit = { NOT = { scope:event_root = { has_variable = installed_child_found } } NOT = { is_adult = yes } }
					# Check if any parent of this court child has a claim on the primary title
					if = { limit = { any_parent = { has_claim_on = scope:tmp_primary_title } }
						save_scope_as = installed_child
						# record we found one to avoid multiple installations
						scope:event_root = { set_variable = { name = installed_child_found value = yes } }
								# If we already selected a challenger, make the child employed by them
								if = { limit = { scope:event_root = { has_variable = challenger_camp_created } } 
									if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } 
										set_employer = scope:challenger }
								}
					}
				}
			}
		}

		hidden_effect = {
			# Kill ~50% of courtiers and guests
			scope:event_root = {
				every_courtier_or_guest = {
					limit = {
						is_alive = yes
						NOT = { this = root }
						# Don't accidentally kill the challenger during the purge
						NOT = { this = scope:challenger }
						# Also protect the installed child and anyone already employed by the challenger
						NOT = { this = scope:installed_child }
						NOT = { employer = scope:challenger }
					}
						# Assign employer - prefer installed child if one is installed, otherwise the challenger
						if = {
							limit = { employer != scope:challenger scope:event_root = { has_variable = challenger_camp_created } }
							if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } is_landed = yes } } set_employer = scope:installed_child }
							else_if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } set_employer = scope:challenger }
						}
						# Then randomize deaths
						random_list = {
							50 = {
								death = {
									death_reason = death_in_palace_coup
									killer = scope:challenger
								}
							}
							50 = { }
						}
				}
			}
		}
	}

	# set a cooldown used by the low stability system (on root)
	set_variable = { name = low_stability_cooldown value = yes years = 5 }

	# Also set the cooldown variable on the challenger to prevent immediate repeat triggers
	if = { limit = { exists = scope:challenger } scope:challenger = { set_variable = { name = low_stability_cooldown value = yes years = 5 } } }

	# Also set the cooldown variable on the installed child to prevent immediate repeat triggers
	if = { limit = { exists = scope:installed_child } scope:installed_child = { set_variable = { name = low_stability_cooldown value = yes years = 5 } } }
}

##########################
# Rise and Fall - Palace Coup Root Wins Prowess Duel
# Kills the challenger when root wins the prowess duel

riseandfall_palace_coup_root_wins_prowess_duel = {
	if = {
		limit = { exists = scope:challenger }
		scope:challenger = {
			death = {
				death_reason = death_duel
				killer = scope:event_root
			}
		}
	}
}

##########################
# Rise and Fall - Palace Coup Challenger Wins Prowess Duel
# Transfers titles, vassals, gold, and triggers root death when challenger wins the prowess duel

riseandfall_palace_coup_challenger_wins_prowess_duel = {
	# Challenger seizes titles while root is still alive
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
	}
	# Normally transfer titles next (child keeps top-level if installed)
	# Transfer all non-barony titles from root to challenger
	# but do not transfer head-of-faith titles
	every_held_title = {
		limit = {
			holder = root
			NOT = { tier = tier_barony }
			NOT = { is_head_of_faith = yes }
			NOT = { is_noble_family_title = yes }
		}
		if = {
			limit = { exists = scope:installed_child }
			change_title_holder = {
				holder = scope:installed_child
				change = scope:change
				take_baronies = yes
			}
		}
		else = {
			change_title_holder = {
				holder = scope:challenger
				change = scope:change
				take_baronies = yes
			}
		}
	}
	# Transfer all direct vassals of the old ruler to the challenger
	# while preserving noble-family titles on root. This ensures the
	# family duchy remains with the dynasty but without actual vassals.
	root = {
		every_vassal = {
			if = {
				limit = { exists = scope:installed_child }
				change_liege = { liege = scope:installed_child change = scope:change }
			}
			else = {
				change_liege = { liege = scope:challenger change = scope:change }
			}
		}
	}
	resolve_title_and_vassal_change = scope:change
	scope:challenger = {
		if = {
			limit = { root = { has_legitimacy = yes } }
			add_legitimacy = -1200
		}
	}

	scope:challenger = {
		add_trait = murderer
	}

			scope:event_root = {
					every_courtier_or_guest = {
						limit = {
							is_alive = yes
							this != root
							this != scope:challenger
							this != scope:installed_child
						}

							# Assign employer to challenger (or installed child if present)
							if = {
								limit = { employer != scope:challenger scope:event_root = { has_variable = challenger_camp_created } }
								if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } is_landed = yes } } set_employer = scope:installed_child }
								else_if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } set_employer = scope:challenger }
							}
				random = {
					chance = 100

				if = {
					limit = {
						not = { exists = involved_activity }
					}

					set_location_to_default = yes
				}
				else = {
					return_to_court = yes
				}
			}
		}
	}

	# Transfer all of root's gold to challenger (root will die) then trigger death event for root

	# Save root gold amount then give it to the challenger (use saved event_root scope)

	scope:event_root = {
		if = { limit = { gold > 1 } set_variable = { name = duel_transfer_gold value = gold } }
	}
	# Add to challenger from the saved event_root variable
	scope:challenger = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } add_short_term_gold = scope:event_root.var:duel_transfer_gold }
	}
	# Remove gold from event_root and cleanup variable
	scope:event_root = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } remove_short_term_gold = scope:event_root.var:duel_transfer_gold }
		remove_variable = duel_transfer_gold
	}
	# Trigger the root death followup
	root = { trigger_event = { id = palace_coup.1004 } }

	# Clean up: if we installed a child, make sure they are seated at their court
	if = {
		limit = { exists = scope:installed_child }
		scope:installed_child = { set_location_to_default = yes }
	}

	# (moved) Clean up: destroy the temporary adventurer camp title if it exists � moved after diarchy & transfers

	# If we installed a child and challenger is alive, make the challenger a puppet diarch
	if = {
		limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
		scope:installed_child = {
			set_diarch = scope:challenger
			set_diarchy_type = puppet_regency
			set_diarchy_swing = 90
		}
	}

	# Move challenger courtiers/followers to installed child's court when challenge becomes puppet master
	if = {
		limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
				scope:challenger = {
								scope:event_root = {
								every_courtier_or_guest = {
								limit = { NOT = { this = scope:installed_child } NOT = { this = scope:challenger } }
								if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } is_landed = yes } } set_employer = scope:installed_child }
				if = {
					limit = { not = { exists = involved_activity } }
					set_location_to_default = yes
				}
				else = { return_to_court = yes }
			}
		}
	}

	# Clean up: destroy the temporary adventurer camp title if it exists (after moving courtiers)
	if = {
		limit = { scope:event_root = { has_variable = challenger_camp_created } scope:challenger = { is_alive = yes } }
		scope:challenger = { destroy_title = scope:palace_coup_challenger_camp_title }
	}
	else_if = {
		limit = { scope:event_root = { has_variable = challenger_camp_created } }
		root = { destroy_title = scope:palace_coup_challenger_camp_title }
		}
	}
}

##########################
# Rise and Fall - Palace Coup Root Flees Success
# Transfers some titles, vassals, gold, makes rivals, and triggers call banners when root successfully flees

riseandfall_palace_coup_root_flees_success = {
	# Transfer root's capital county (if any) to challenger, then transfer all duchy+ titles
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
	}
	# Transfer capital county specifically (if it exists and is held by root).
	if = {
		limit = { root = { capital_county = { exists = yes } } }
		root = {
			capital_county = {
				if = {
					limit = { exists = scope:installed_child }
					change_title_holder = {
						holder = scope:installed_child
						change = scope:change
						take_baronies = yes
					}
				}
				else = {
					change_title_holder = {
						holder = scope:challenger
						change = scope:change
						take_baronies = yes
					}
				}
			}
		}
	}
	# If the root has an administrative government, they should lose all
	# titles except their counties (the capital county is transferred above).
	# Transfer any remaining duchy+ titles so the challenger outranks root
	# for the subsequent vassalage change. For non-administrative roots,
	# keep the prior behavior (transfer duchy+).
	if = {
		limit = { root = { is_landed_or_landless_administrative = yes } }
		# Administrative branch: transfer all titles above the county tier
		every_held_title = {
			limit = {
				holder = root
				NOT = { tier = tier_county }
				NOT = { tier = tier_barony }
				NOT = { is_head_of_faith = yes }
				NOT = { is_noble_family_title = yes }
			}
				if = {
					limit = { exists = scope:installed_child }
					change_title_holder = {
						holder = scope:installed_child
						change = scope:change
						take_baronies = yes
					}
				}
				else = {
					change_title_holder = {
						holder = scope:challenger
						change = scope:change
						take_baronies = yes
					}
				}
			}
		}
	else = {
		# Non-administrative branch: transfer duchy+ as before
		# Transfer all duchy+ titles (exclude counties and baronies)
		# but do not transfer head-of-faith titles
		every_held_title = {
			limit = {
				holder = root
				NOT = {
					OR = {
						tier = tier_county
						tier = tier_barony
					}
				}
				NOT = { is_head_of_faith = yes }
				NOT = { is_noble_family_title = yes }
			}
			if = {
				limit = { exists = scope:installed_child }
				change_title_holder = {
					holder = scope:installed_child
					change = scope:change
					take_baronies = yes
				}
			}
			else = {
				change_title_holder = {
					holder = scope:challenger
					change = scope:change
					take_baronies = yes
				}
			}
		}
	}
		                
	# Make the old ruler (root) a vassal of the challenger and
	# transfer direct vassals to the challenger in the same change
	root = {
		# If we installed a child, make root a vassal of the child; otherwise make root a vassal of the challenger
		if = {
			limit = { exists = scope:installed_child }
			change_liege = {
				liege = scope:installed_child
				change = scope:change
			}
		}
		else = {
			change_liege = {
				liege = scope:challenger
				change = scope:change
			}
		}
	}
	# Transfer direct vassals for non-administrative roots only. For
	# administrative rulers we keep their vassals so duchies/counties remain
	# intact under the root.
	if = {
		limit = { NOT = { root = { is_landed_or_landless_administrative = yes } } }
		root = {
			every_vassal = {
				change_liege = {
					liege = scope:challenger
					change = scope:change
				}
			}
		}
	}
	resolve_title_and_vassal_change = scope:change

	# Give root strong claims on all titles lost to the challenger
	every_in_list = {
		list = lost_titles
		root = { make_claim_strong = prev }
	}


	# Trigger escape follow-up: call banners event for root
	# Transfer 50% of root's gold to the challenger when root escapes

	scope:event_root = {
		if = {
			limit = { gold > 1 }
			# Save root gold amount then reduce to 50% for transfer
			set_variable = { name = duel_transfer_gold value = gold }
			change_variable = { name = duel_transfer_gold multiply = 0.5 }
		}
	}
	# Add the 50% to the challenger and remove it from event_root

	scope:challenger = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } add_short_term_gold = scope:event_root.var:duel_transfer_gold }
	}
	scope:event_root = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } remove_short_term_gold = scope:event_root.var:duel_transfer_gold }
		remove_variable = duel_transfer_gold
	}
	# Trigger escape follow-up: call banners event for root
	root = { trigger_event = { id = palace_coup.1003 } }

	# Clean up: if we installed a child, make sure they are seated at their court
	if = {
		limit = { exists = scope:installed_child }
		scope:installed_child = { set_location_to_default = yes }
	}

	# (moved) Clean up: destroy the temporary adventurer camp title if it still exists � moved after diarchy & transfers

	scope:challenger = {
		if = {
			limit = { root = { has_legitimacy = yes } }
			add_legitimacy = -1200
		}
	}

	# Make root and the challenger rivals of each other
	root = {
		if = {
			limit = { can_set_relation_rival_trigger = { CHARACTER = scope:challenger } }
			set_relation_rival = {
				target = scope:challenger
				reason = riseandfall_adventurer_became_rival
			}
		}
	}

	# If installed child and challenger alive, ensure child is seated and challenger puppet master
	if = {
		limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
		scope:installed_child = { set_location_to_default = yes }
		# Make the challenger the diarch (puppet regency)
		scope:installed_child = {
			set_diarch = scope:challenger
			set_diarchy_type = puppet_regency
			set_diarchy_swing = 90
		}

		# Move challenger courtiers/followers to installed child's court when challenge becomes puppet master
		if = {
			limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
				scope:challenger = {
							scope:event_root = {
							every_courtier_or_guest = {
								limit = { is_alive = yes NOT = { this = scope:installed_child } NOT = { this = scope:challenger } }
							if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } is_landed = yes } } set_employer = scope:installed_child }
					if = {
						limit = { not = { exists = involved_activity } }
						set_location_to_default = yes
					}
					else = { return_to_court = yes }
				}
			}
		}

		# Clean up: destroy the temporary adventurer camp title if it still exists (after moving courtiers)
		if = {
			limit = { scope:event_root = { has_variable = challenger_camp_created } scope:challenger = { is_alive = yes } }
			scope:challenger = { destroy_title = scope:palace_coup_challenger_camp_title }
		}
		else_if = {
			limit = { scope:event_root = { has_variable = challenger_camp_created } }
			root = { destroy_title = scope:palace_coup_challenger_camp_title }
		}

		# Child keeps top realm titles; challenger will be made puppet diarch instead
	}

	# (diarchy already applied above for installed child)
	scope:challenger = {
		if = {
			limit = { can_set_relation_rival_trigger = { CHARACTER = root } }
			set_relation_rival = {
				target = root
				reason = riseandfall_adventurer_became_rival
			}
		}
	}

	scope:event_root = {
		every_courtier_or_guest = {
			limit = {
				this != root
				this != scope:challenger
				this != scope:installed_child
			}

					# Assign employer to challenger when possible
					if = {
						limit = { employer != scope:challenger scope:event_root = { has_variable = challenger_camp_created } }
							if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } } } set_employer = scope:installed_child }
								else_if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } set_employer = scope:challenger }
					}
				random = {
					chance = 50

				if = {
					limit = {
						not = { exists = involved_activity }
					}

					set_location_to_default = yes
				}
				else = {
					return_to_court = yes
					}
				}
			}
		}
	}
}

##########################
# Rise and Fall - Palace Coup Root Flees Failure
# Transfers all titles, vassals, gold, makes rivals, and imprisons root when root fails to flee

riseandfall_palace_coup_root_flees_failure = {
	create_title_and_vassal_change = {
		type = conquest
		save_scope_as = change
	}
	# Make the old ruler a vassal of the challenger, or of the installed child if present
	root = {
		if = {
			limit = { exists = scope:installed_child }
			change_liege = { liege = scope:installed_child change = scope:change }
		}
		else = {
			change_liege = { liege = scope:challenger change = scope:change }
		}
	}
	# (No top realm transfer here when we installed a child � the child should retain top titles)

	# Transfer all titles from root to challenger
	# but do not transfer head-of-faith titles
	every_held_title = {
		limit = {
			holder = root
			NOT = { tier = tier_barony }
			NOT = { is_head_of_faith = yes }
			NOT = { is_noble_family_title = yes }
		}
		if = {
			limit = { exists = scope:installed_child }
			change_title_holder = {
				holder = scope:installed_child
				change = scope:change
				take_baronies = yes
			}
		}
		else = {
			change_title_holder = {
				holder = scope:challenger
				change = scope:change
				take_baronies = yes
			}
		}
	}
	# Transfer all direct vassals of the old ruler to the challenger
	# while preserving noble-family titles on root.
	root = {
		every_vassal = {
			if = {
				limit = { exists = scope:installed_child }
				change_liege = { liege = scope:installed_child change = scope:change }
			}
			else = {
				change_liege = { liege = scope:challenger change = scope:change }
			}
		}
	}
	resolve_title_and_vassal_change = scope:change
	scope:challenger = {
		if = {
			limit = { root = { has_legitimacy = yes } }
			add_legitimacy = -1200
		}
	}

	# Make root and the challenger rivals of each other
	root = {
		if = {
			limit = { can_set_relation_rival_trigger = { CHARACTER = scope:challenger } }
			set_relation_rival = {
				target = scope:challenger
				reason = riseandfall_adventurer_became_rival
			}
		}
	}
	scope:challenger = {
		if = {
			limit = { can_set_relation_rival_trigger = { CHARACTER = root } }
			set_relation_rival = {
				target = root
				reason = riseandfall_adventurer_became_rival
			}
		}
	}

			root = {
				every_courtier_or_guest = {
					limit = {
						is_alive = yes
						this != root
						this != scope:challenger
					}

			random = {
				chance = 100

				if = {
					limit = {
						employer != scope:challenger
						scope:event_root = { has_variable = challenger_camp_created }
					}
						if = { limit = { exists = scope:installed_child } 
							if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } } } set_employer = scope:installed_child }
									else_if = { limit = { exists = scope:challenger scope:challenger = { is_alive = yes NOT = { is_ruler = yes } has_title = scope:palace_coup_challenger_camp_title } } set_employer = scope:challenger }
						}
				}

				if = {
					limit = {
						not = { exists = involved_activity }
					}

					set_location_to_default = yes
				}
				else = {
					return_to_court = yes
				}
			}
		}
	}


	# Transfer all of root's gold to challenger (root will be imprisoned)

	scope:event_root = {
		if = { limit = { gold > 1 } set_variable = { name = duel_transfer_gold value = gold } }
	}
	scope:challenger = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } add_short_term_gold = scope:event_root.var:duel_transfer_gold }
	}
	scope:event_root = {
		if = { limit = { scope:event_root = { has_variable = duel_transfer_gold } } remove_short_term_gold = scope:event_root.var:duel_transfer_gold }
		remove_variable = duel_transfer_gold
	}
	# Imprison the root: challenger captures/seizes the ruler
	scope:challenger = { imprison = { target = root type = dungeon } }

	# If we installed a child, make the challenger the child's puppet (diarch) and seat the child
	if = {
		limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
		scope:installed_child = { set_location_to_default = yes }
		scope:installed_child = {
			set_diarch = scope:challenger
			set_diarchy_type = puppet_regency
			set_diarchy_swing = 90
		}
	}

		# Move challenger courtiers/followers to installed child's court when challenge becomes puppet master
		if = {
			limit = { exists = scope:installed_child scope:challenger = { is_alive = yes } }
			scope:challenger = {
						scope:event_root = {
						every_courtier_or_guest = {
							limit = { is_alive = yes NOT = { this = scope:installed_child } NOT = { this = scope:challenger } }
									if = { limit = { exists = scope:installed_child scope:installed_child = { is_alive = yes NOT = { is_ruler = yes } } } set_employer = scope:installed_child }
					if = {
						limit = { not = { exists = involved_activity } }
						set_location_to_default = yes
					}
					else = { return_to_court = yes }
				}
			}
		}

		# Clean up: destroy the temporary adventurer camp title if it still exists (after moving courtiers)
		if = {
			limit = { scope:event_root = { has_variable = challenger_camp_created } scope:challenger = { is_alive = yes } }
			scope:challenger = { destroy_title = scope:palace_coup_challenger_camp_title }
		}
		else_if = {
			limit = { scope:event_root = { has_variable = challenger_camp_created } }
			root = { destroy_title = scope:palace_coup_challenger_camp_title }
		}

	# Clean up: if we installed a child, make sure they are seated at their court
	if = {
		limit = { exists = scope:installed_child }
		scope:installed_child = { set_location_to_default = yes }
	}

	# (removed duplicate) Cleanup handled above after transfers
	}
}

##########################
# Rise and Fall - Palace Coup Challenger Calls Banners
# Triggers the warlord event for the challenger to call banners

riseandfall_palace_coup_challenger_calls_banners = {
	# If a child was installed, the child is the liege � trigger warlord event for the liege (child)
	if = {
		limit = { exists = scope:installed_child }
		scope:installed_child = { trigger_event = { id = warlord.1001 } }
	}
	else = {
		scope:challenger = { trigger_event = { id = warlord.1001 } }
	}
}

##########################
# Rise and Fall - Palace Coup Root Death
# Kills the root character

riseandfall_palace_coup_root_death = {
	root = {
		death = {
			death_reason = death_duel
			killer = scope:challenger
		}
	}
}
