###############################
# Rise and Fall - Realm Stability
# Computes a 0..100 realm stability score and stores it on the ruler as
# riseandfall_realm_stability_score
# Weighting (user spec):
#  - 25% ruler stats (Diplomacy/Martial/Stewardship/Intrigue/Learning)
#    For every full 10 points in a stat -> +5 (max 25)
#  - 10% regency/child (binary penalty: 0 => 10, yes => 0)
#  - 15% debt ("gold option 3" threshold: considered in_debt if gold < -3 * monthly_character_income)
#    if in debt -> scale up to full 15 based on how deep the debt is (clamped)
#  - 25% legitimacy (based on ruler's legitimacy level: 1=0, 2=5, 3=10, 4=17, 5=25)
#  - 25% vassal relations (average direct vassal opinion -100..100 mapped to 0..25)

riseandfall_calculate_realm_stability_se = {
    # Root scope: called from an every_ruler on_action, so root is the ruler
    # Clear any previous working vars
    remove_variable = riseandfall_rs_stats_component
    remove_variable = riseandfall_rs_regency_component
    remove_variable = riseandfall_rs_debt_component
    remove_variable = riseandfall_rs_vassals_component

    ########################################
    # 1) RULER STATS (25 points max)
    # Simplified rule: each 1 stat ≈ 0.3333 stability points (15 stat -> 5 points), capped at 5 per stat
    set_variable = { name = riseandfall_rs_stats_component value = 0 }

    # Diplomacy
    set_variable = { name = tmp_add value = diplomacy }
    # approximate multiply 0.333 by dividing by 3 to avoid decimal literal parsing
    change_variable = { name = tmp_add divide = 3 }
    clamp_variable = { name = tmp_add min = 0 max = 5 }
    change_variable = { name = riseandfall_rs_stats_component add = var:tmp_add }

    # Martial
    set_variable = { name = tmp_add value = martial }
    change_variable = { name = tmp_add divide = 3 }
    clamp_variable = { name = tmp_add min = 0 max = 5 }
    change_variable = { name = riseandfall_rs_stats_component add = var:tmp_add }
        # Note: do NOT remove `riseandfall_realm_stability_score` here — it is the persistent
        # "current" stability we will nudge slowly toward the freshly-calculated target.
    # Stewardship
    set_variable = { name = tmp_add value = stewardship }
    change_variable = { name = tmp_add divide = 3 }
    clamp_variable = { name = tmp_add min = 0 max = 5 }
    change_variable = { name = riseandfall_rs_stats_component add = var:tmp_add }

    # Intrigue
    set_variable = { name = tmp_add value = intrigue }
    change_variable = { name = tmp_add divide = 3 }
    clamp_variable = { name = tmp_add min = 0 max = 5 }
    change_variable = { name = riseandfall_rs_stats_component add = var:tmp_add }

    # Learning
    set_variable = { name = tmp_add value = learning }
    change_variable = { name = tmp_add divide = 3 }
    clamp_variable = { name = tmp_add min = 0 max = 5 }
    change_variable = { name = riseandfall_rs_stats_component add = var:tmp_add }

    # Clamp stats component to 0..25
    clamp_variable = { name = riseandfall_rs_stats_component min = 0 max = 25 }

    ########################################
    # 2) REGENCY / CHILD CHECK (10 points)
    # If ruler is a child OR has an active regency diarchy type, they lose the 10 points (we award 0 if regency/child present, 10 otherwise)
    set_variable = { name = riseandfall_rs_regency_component value = 10 }
    if = {
        # Child check: use age 0..15 to detect child rulers (safer syntax than is_child)
        limit = { age = { 0 15 } }
        set_variable = { name = riseandfall_rs_regency_component value = 0 }
    }

    ########################################
    # 3) DEBT (15 points) - gold option 3
    # Consider in_debt if gold < -3 * monthly_character_income
    # We scale contribution 0..15 where shallower debt gives smaller penalty.
    set_variable = { name = riseandfall_rs_debt_component value = 15 }
    set_variable = { name = tmp_gold value = gold }
    set_variable = { name = tmp_income value = monthly_character_income }
    # threshold = -3 * income
    set_variable = { name = tmp_threshold value = var:tmp_income }
    change_variable = { name = tmp_threshold multiply = -3 }

    if = {
        limit = { var:tmp_gold < var:tmp_threshold }
        # depth = abs(gold / threshold) (positive number > 1)
        # approximate scale: depth_factor = min( (abs(tmp_gold) / abs(tmp_threshold)), 2 ) then map to 0..15
    set_variable = { name = tmp_gold_abs value = var:tmp_gold }
    change_variable = { name = tmp_gold_abs multiply = -1 }
    set_variable = { name = tmp_threshold_abs value = var:tmp_threshold }
    change_variable = { name = tmp_threshold_abs multiply = -1 }
        set_variable = { name = tmp_depth_ratio value = 0 }
        # avoid divide: use multiply by (1/threshold_abs) via change_variable multiply if threshold_abs non-zero.
        # We approximate ratio by scaling: tmp_depth_ratio = tmp_gold_abs * 0.3333 / tmp_threshold_abs  -> simplifies to tmp_gold_abs/tmp_income
    set_variable = { name = tmp_depth_ratio value = var:tmp_gold_abs }
    # avoid decimal literal parsing issues; divide by 3 instead of multiplying by 0.333333
    change_variable = { name = tmp_depth_ratio divide = 3 }
    change_variable = { name = tmp_depth_ratio add = 0 } # ensure variable exists
        # Clamp depth between 0 and 2
        clamp_variable = { name = tmp_depth_ratio min = 0 max = 2 }
        # ratio 1 -> full 15, ratio 2 -> also full (cap). We'll map ratio 0..2 -> 0..15
    change_variable = { name = riseandfall_rs_debt_component multiply = var:tmp_depth_ratio }
        clamp_variable = { name = riseandfall_rs_debt_component min = 0 max = 15 }
    }

    ########################################
    # 4) LEGITIMACY (0..25) - based on ruler's legitimacy level
    # Map legitimacy levels 1-5 to stability points: 1=0, 2=5, 3=10, 4=17, 5=25
    set_variable = { name = riseandfall_rs_legitimacy_component value = 0 }
    
    # Check legitimacy level and assign corresponding points
    if = {
        limit = { legitimacy_level = 2 }
        set_variable = { name = riseandfall_rs_legitimacy_component value = 5 }
    }
    else_if = {
        limit = { legitimacy_level = 3 }
        set_variable = { name = riseandfall_rs_legitimacy_component value = 10 }
    }
    else_if = {
        limit = { legitimacy_level = 4 }
        set_variable = { name = riseandfall_rs_legitimacy_component value = 17 }
    }
    else_if = {
        limit = { legitimacy_level = 5 }
        set_variable = { name = riseandfall_rs_legitimacy_component value = 25 }
    }
    # Level 1 defaults to 0 (already set above)

    ########################################
    # 5) VASSAL RELATIONS (25 points max)
    # Calculate average vassal opinion across every_vassal (negatives treated as 0)
    set_variable = { name = riseandfall_rs_vassals_component value = 0 }
    # Save ruler scope and prepare accumulators
    save_scope_as = ruler_scope
    set_variable = { name = tmp_vassal_count value = vassal_count }
    set_variable = { name = tmp_opinion_sum value = 0 }

    # If there are any vassals, iterate them and add their non-negative opinion to the sum
    every_vassal = {
        save_scope_as = iter_vassal
        # From the ruler scope, evaluate the vassal's opinion of the ruler via opinion triggers
        scope:ruler_scope = {
            set_variable = { name = tmp_local_op value = 0 }
            if = { limit = { opinion = { target = scope:iter_vassal value >= 100 } } set_variable = { name = tmp_local_op value = 100 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 96 } } set_variable = { name = tmp_local_op value = 96 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 92 } } set_variable = { name = tmp_local_op value = 92 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 88 } } set_variable = { name = tmp_local_op value = 88 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 84 } } set_variable = { name = tmp_local_op value = 84 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 80 } } set_variable = { name = tmp_local_op value = 80 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 76 } } set_variable = { name = tmp_local_op value = 76 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 72 } } set_variable = { name = tmp_local_op value = 72 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 68 } } set_variable = { name = tmp_local_op value = 68 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 64 } } set_variable = { name = tmp_local_op value = 64 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 60 } } set_variable = { name = tmp_local_op value = 60 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 56 } } set_variable = { name = tmp_local_op value = 56 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 52 } } set_variable = { name = tmp_local_op value = 52 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 48 } } set_variable = { name = tmp_local_op value = 48 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 44 } } set_variable = { name = tmp_local_op value = 44 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 40 } } set_variable = { name = tmp_local_op value = 40 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 36 } } set_variable = { name = tmp_local_op value = 36 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 32 } } set_variable = { name = tmp_local_op value = 32 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 28 } } set_variable = { name = tmp_local_op value = 28 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 24 } } set_variable = { name = tmp_local_op value = 24 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 20 } } set_variable = { name = tmp_local_op value = 20 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 16 } } set_variable = { name = tmp_local_op value = 16 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 12 } } set_variable = { name = tmp_local_op value = 12 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 8 } } set_variable = { name = tmp_local_op value = 8 } }
            else_if = { limit = { opinion = { target = scope:iter_vassal value >= 4 } } set_variable = { name = tmp_local_op value = 4 } }
            else = { set_variable = { name = tmp_local_op value = 0 } }

            # Add this vassal's non-negative opinion to the running sum
            change_variable = { name = tmp_opinion_sum add = var:tmp_local_op }
        }
    }

    # Compute average (if there are vassals) and scale to 0..25 by dividing by 4
    # initialize tmp_avg_opinion so clamp/divide calls are safe when there are no vassals
    set_variable = { name = tmp_avg_opinion value = 0 }
    if = {
        limit = { var:tmp_vassal_count > 0 }
        set_variable = { name = tmp_avg_opinion value = var:tmp_opinion_sum }
        change_variable = { name = tmp_avg_opinion divide = var:tmp_vassal_count }
    }
    clamp_variable = { name = tmp_avg_opinion min = 0 max = 100 }
    # scale raw average (0..100) to component range 0..25 by dividing by 4
    change_variable = { name = tmp_avg_opinion divide = 4 }
    # store scaled average (0..25)
    set_variable = { name = riseandfall_rs_vassals_component value = var:tmp_avg_opinion }

    clamp_variable = { name = riseandfall_rs_vassals_component min = 0 max = 25 }

    ########################################
    # Sum components into final 0..100 TARGET score (don't overwrite the persistent current score yet)
    # Ensure component vars exist (safe defaults) to avoid unset-variable engine errors
    if = { limit = { NOT = { has_variable = riseandfall_rs_stats_component } } set_variable = { name = riseandfall_rs_stats_component value = 0 } }
    if = { limit = { NOT = { has_variable = riseandfall_rs_regency_component } } set_variable = { name = riseandfall_rs_regency_component value = 0 } }
    if = { limit = { NOT = { has_variable = riseandfall_rs_debt_component } } set_variable = { name = riseandfall_rs_debt_component value = 0 } }
    if = { limit = { NOT = { has_variable = riseandfall_rs_legitimacy_component } } set_variable = { name = riseandfall_rs_legitimacy_component value = 0 } }
    if = { limit = { NOT = { has_variable = riseandfall_rs_vassals_component } } set_variable = { name = riseandfall_rs_vassals_component value = 0 } }
    set_variable = { name = tmp_target_score value = 0 }
    change_variable = { name = tmp_target_score add = var:riseandfall_rs_stats_component }
    change_variable = { name = tmp_target_score add = var:riseandfall_rs_regency_component }
    change_variable = { name = tmp_target_score add = var:riseandfall_rs_debt_component }
    change_variable = { name = tmp_target_score add = var:riseandfall_rs_legitimacy_component }
    change_variable = { name = tmp_target_score add = var:riseandfall_rs_vassals_component }

    clamp_variable = { name = tmp_target_score min = 0 max = 100 }
    round_variable = { name = tmp_target_score }

    # Persist the target so we can smooth changes over time
    set_variable = { name = riseandfall_realm_stability_target value = var:tmp_target_score }

    # Smooth the persistent current score (`riseandfall_realm_stability_score`) toward the target
    # by +/-1 per year. We assume this scripted_effect runs monthly; use an integer month
    # counter `riseandfall_rs_adjust_months` to apply one step every 12 runs.

    # Initialize months counter if missing
    if = {
        limit = { NOT = { has_variable = riseandfall_rs_adjust_months } }
        set_variable = { name = riseandfall_rs_adjust_months value = 0 }
    }
    # If the persistent current score doesn't exist yet, set it equal to the target immediately
    if = {
        limit = { NOT = { has_variable = riseandfall_realm_stability_score } }
        set_variable = { name = riseandfall_realm_stability_score value = var:riseandfall_realm_stability_target }
    }
    else = {
        # increment month counter each run
        change_variable = { name = riseandfall_rs_adjust_months add = 1 }
        # only apply an adjustment when we've accumulated the configured period.
        # This mod schedules the on_action yearly, so check for >= 1 run (one year).
        if = {
            limit = { var:riseandfall_rs_adjust_months >= 1 }
            # reset months counter so we apply at most one adjustment now
            set_variable = { name = riseandfall_rs_adjust_months value = 0 }
            # move current score up to 3 points toward the target (no overshoot)
            # compute delta = target - current
            # compute delta = target - current without using invalid '-var:' syntax
            set_variable = { name = tmp_rs_delta value = var:riseandfall_realm_stability_target }
            set_variable = { name = tmp_rs_current_neg value = var:riseandfall_realm_stability_score }
            change_variable = { name = tmp_rs_current_neg multiply = -1 }
            change_variable = { name = tmp_rs_delta add = var:tmp_rs_current_neg }
            # if target is higher
            if = {
                limit = { var:tmp_rs_delta >= 3 }
                change_variable = { name = riseandfall_realm_stability_score add = 3 }
            }
            else_if = {
                limit = { var:tmp_rs_delta > 0 }
                change_variable = { name = riseandfall_realm_stability_score add = var:tmp_rs_delta }
            }
            else = {
                # target is lower or equal; work with absolute negative delta
                set_variable = { name = tmp_rs_delta_neg value = var:tmp_rs_delta }
                change_variable = { name = tmp_rs_delta_neg multiply = -1 }
                if = {
                    limit = { var:tmp_rs_delta_neg >= 3 }
                    change_variable = { name = riseandfall_realm_stability_score add = -3 }
                }
                else_if = {
                    limit = { var:tmp_rs_delta_neg > 0 }
                    # add negative of the remaining distance
                    set_variable = { name = tmp_rs_neg_step value = var:tmp_rs_delta_neg }
                    change_variable = { name = tmp_rs_neg_step multiply = -1 }
                    change_variable = { name = riseandfall_realm_stability_score add = var:tmp_rs_neg_step }
                }
            }
        }
    }

    # Ensure current score remains clamped and integer
    clamp_variable = { name = riseandfall_realm_stability_score min = 0 max = 100 }
    round_variable = { name = riseandfall_realm_stability_score }

    # Set exactly one character flag representing the stability band based on the CURRENT score:
    # 0-20: collapsing
    # 21-40: low
    # 41-60: average
    # 61-80: good
    # 81-100: golden_age
    # First, clear any existing stability variables so we only have one active variable.
    # Use a single numeric stage variable (1..5) for robustness.
    remove_variable = riseandfall_realm_stability_stage
    # Also clear legacy boolean vars if present
    remove_variable = riseandfall_realm_stability_collapsing
    remove_variable = riseandfall_realm_stability_low
    remove_variable = riseandfall_realm_stability_average
    remove_variable = riseandfall_realm_stability_good
    remove_variable = riseandfall_realm_stability_golden_age

    # Nested if/else chain to assign exactly one flag based on the score
    # Map score ranges to a single stage number: 1=collapsing,2=low,3=average,4=good,5=golden
    if = {
        limit = { var:riseandfall_realm_stability_score <= 20 }
        set_variable = { name = riseandfall_realm_stability_stage value = 1 }
    }
    else = {
        if = {
            limit = { var:riseandfall_realm_stability_score <= 40 }
            set_variable = { name = riseandfall_realm_stability_stage value = 2 }
        }
        else = {
            if = {
                limit = { var:riseandfall_realm_stability_score <= 60 }
                set_variable = { name = riseandfall_realm_stability_stage value = 3 }
            }
            else = {
                if = {
                    limit = { var:riseandfall_realm_stability_score <= 80 }
                    set_variable = { name = riseandfall_realm_stability_stage value = 4 }
                }
                else = {
                    # 81-100
                    set_variable = { name = riseandfall_realm_stability_stage value = 5 }
                }
            }
        }
    }

    # Maintain legacy boolean flags for compatibility (ensure they're set somewhere)
    set_variable = { name = riseandfall_realm_stability_collapsing value = 0 }
    set_variable = { name = riseandfall_realm_stability_low value = 0 }
    set_variable = { name = riseandfall_realm_stability_average value = 0 }
    set_variable = { name = riseandfall_realm_stability_good value = 0 }
    set_variable = { name = riseandfall_realm_stability_golden_age value = 0 }

    # Set the appropriate legacy flag to 1 for compatibility with older code
    if = {
        limit = { var:riseandfall_realm_stability_stage = 1 }
        set_variable = { name = riseandfall_realm_stability_collapsing value = 1 }
    }
    else_if = { limit = { var:riseandfall_realm_stability_stage = 2 } set_variable = { name = riseandfall_realm_stability_low value = 1 } }
    else_if = { limit = { var:riseandfall_realm_stability_stage = 3 } set_variable = { name = riseandfall_realm_stability_average value = 1 } }
    else_if = { limit = { var:riseandfall_realm_stability_stage = 4 } set_variable = { name = riseandfall_realm_stability_good value = 1 } }
    else = { set_variable = { name = riseandfall_realm_stability_golden_age value = 1 } }

    # Ensure exactly one stage modifier is present on the ruler matching the stability flag.
    # Remove any old stage modifiers first, then add the correct one.
    remove_character_modifier = riseandfall_stage1_stability
    remove_character_modifier = riseandfall_stage2_stability
    remove_character_modifier = riseandfall_stage3_stability
    remove_character_modifier = riseandfall_stage4_stability
    remove_character_modifier = riseandfall_stage5_stability

    # Choose modifier based on numeric stage variable
    if = {
        limit = { var:riseandfall_realm_stability_stage = 1 }
        add_character_modifier = { modifier = riseandfall_stage1_stability }
    }
    else_if = {
        limit = { var:riseandfall_realm_stability_stage = 2 }
        add_character_modifier = { modifier = riseandfall_stage2_stability }
    }
    else_if = {
        limit = { var:riseandfall_realm_stability_stage = 3 }
        add_character_modifier = { modifier = riseandfall_stage3_stability }
    }
    else_if = {
        limit = { var:riseandfall_realm_stability_stage = 4 }
        add_character_modifier = { modifier = riseandfall_stage4_stability }
    }
    else = {
        add_character_modifier = { modifier = riseandfall_stage5_stability }
    }

}
