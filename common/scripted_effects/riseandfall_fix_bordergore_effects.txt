############################################################
# Rise and Fall: Fix Bordergore scripted effects
# Called by a character interaction where a liege fixes vassal-held duchies/kingdoms
# Behavior: iterate titles held by the recipient (duchy+). If the title's de jure liege
# is the actor (the liege), transfer the title (and vassals) to the liege.
############################################################

riseandfall_fix_bordergore_se = {
    # CONTRACT (inputs/outputs/data/error)
    # Inputs: scope:actor (liege), scope:recipient (vassal)
    # Outputs: Non–de jure counties (direct or sub‑realm) moved to liege; aggregate notification if any moved.
    # Data shape: title holder changes via create_title_and_vassal_change / change_title_holder_include_vassals.
    # Error modes: Missing scopes (no action), no non–de jure counties (no message), invalid token (engine log error).

    save_scope_as = liege

    # 1. Directly held counties by recipient that are outside ALL recipient de jure chains, but not already held by liege.
    scope:recipient = {
        every_held_title = {
            limit = {
                tier = tier_county
                exists = de_jure_liege
                holder = scope:recipient
                # Exclude any county whose de jure chain (up to empire) is held by the recipient
                NOT = { de_jure_liege = { holder = scope:recipient } }
                NOT = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } }
                NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } }
                NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } } }
                # Don't process if already held by liege
                NOT = { holder = scope:liege }
            }
            create_title_and_vassal_change = { type = granted save_scope_as = change }
            change_title_holder_include_vassals = { holder = scope:liege change = scope:change take_baronies = no }
            resolve_title_and_vassal_change = scope:change
            scope:liege = { set_variable = { name = riseandfall_fix_bordergore_made_changes value = 1 } }
        }
    }

    # 2. Sub‑realm counties (held by recipient's vassals) outside recipient de jure chains.
    scope:recipient = {
        every_sub_realm_county = {
            limit = {
                exists = this
                exists = de_jure_liege
                NOT = { de_jure_liege = { holder = scope:recipient } }
                NOT = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } }
                NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } }
                NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } } }
                NOT = { holder = scope:liege }
                NOT = { holder = scope:recipient }
                NOT = { this = scope:liege.capital_province.county }
                NOT = { this = scope:recipient.capital_province.county }
            }
            save_scope_as = target_county
            if = {
                limit = { NOT = { AND = { scope:target_county = { has_variable = Riseandfall_giveaway_blocked } scope:liege = { is_ai = no } } } }
                create_title_and_vassal_change = { type = granted save_scope_as = change }
                scope:target_county = { change_title_holder_include_vassals = { holder = scope:liege change = scope:change take_baronies = no } }
                resolve_title_and_vassal_change = scope:change
                scope:liege = { set_variable = { name = riseandfall_fix_bordergore_made_changes value = 1 } }
            }
        }
    }

    # 3. Aggregate notification.
    scope:liege = {
        if = {
            limit = { has_variable = riseandfall_fix_bordergore_made_changes }
            send_interface_message = {
                type = send_interface_message_good
                title = riseandfall_fix_bordergore_notification_title
                custom_tooltip = { text = riseandfall_fix_bordergore_notification_desc_aggregate }
                left_icon = scope:liege
            }
            remove_variable = riseandfall_fix_bordergore_made_changes
        }
    }
}
