############################################################
# Rise and Fall: Fix Bordergore scripted effects
# Called by a character interaction where a liege fixes vassal-held duchies/kingdoms
# Behavior: iterate titles held by the recipient (duchy+). If the title's de jure liege
# is the actor (the liege), transfer the title (and vassals) to the liege.
############################################################

riseandfall_fix_bordergore_se = {
    # CONTRACT (inputs/outputs/data/error)
    # Inputs: scope:actor (liege), scope:recipient (vassal)
    # Outputs: Nonde jure counties (direct or subrealm) moved to liege; aggregate notification if any moved.
    # Data shape: title holder changes via create_title_and_vassal_change / change_title_holder_include_vassals.
    # Error modes: Missing scopes (no action), no nonde jure counties (no message), invalid token (engine log error).

    save_scope_as = liege

    # 1. Directly held counties by recipient that are outside ALL recipient de jure chains, but not already held by liege.
    scope:recipient = {
        # Save recipient's capital's de jure kingdom
        capital_province = {
            county = {
                de_jure_liege = {
                    de_jure_liege = {
                        save_scope_as = recipient_capital_dejure_kingdom
                    }
                }
            }
        }
        every_held_title = {
            # Base filters: only counties directly held by the recipient, not already held by the liege
            limit = {
                tier = tier_county
                exists = de_jure_liege
                holder = scope:recipient
                NOT = { holder = scope:liege }
                # Do not take titles from human players
                NOT = { holder = { is_ai = no } }
                NOT = { scope:recipient = { highest_held_title_tier = tier_county } }  # Do not transfer direct counties from counts
            }

            # Transfer if none of the county's de jure chain (duchy/kingdom/empire) is held by the recipient
            if = {
                limit = {
                    AND = {
                        NOT = { de_jure_liege = { holder = scope:recipient } }
                        NOT = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } }
                        NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } }
                        NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } } }
                        NOT = { AND = { scope:recipient = { highest_held_title_tier = tier_county } de_jure_liege = { de_jure_liege = { this = scope:recipient_capital_dejure_kingdom } } } }
                    }
                }

                create_title_and_vassal_change = { type = granted save_scope_as = change }
                change_title_holder_include_vassals = { holder = scope:liege change = scope:change take_baronies = no }
                resolve_title_and_vassal_change = scope:change
                scope:liege = { set_variable = { name = riseandfall_fix_bordergore_made_changes value = 1 } }
            }
        }
    }

    # (duchy-transfer logic intentionally removed; only counties are transferred)

    # 2. Subrealm counties (held by recipient's vassals) outside recipient de jure chains.
    scope:recipient = {
        every_sub_realm_county = {
            # Base filters: sub-realm county object exists, has de jure info, not liege/recipient capitals, not held by human
            limit = {
                exists = this
                exists = de_jure_liege
                NOT = { holder = scope:liege }
                NOT = { holder = { is_ai = no } }
                NOT = { holder = scope:recipient }
                NOT = { this = scope:liege.capital_province.county }
                NOT = { this = scope:recipient.capital_province.county }
            }
            save_scope_as = target_county

            # Transfer if none of the county's de jure chain owners are the recipient.
            if = {
                limit = {
                    AND = {
                        scope:target_county = { NOT = { de_jure_liege = { holder = scope:recipient } } }
                        scope:target_county = { NOT = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } }
                        scope:target_county = { NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } } }
                        scope:target_county = { NOT = { de_jure_liege = { de_jure_liege = { de_jure_liege = { de_jure_liege = { holder = scope:recipient } } } } } }
                        NOT = { AND = { scope:recipient = { highest_held_title_tier = tier_county } scope:target_county = { de_jure_liege = { de_jure_liege = { this = scope:recipient_capital_dejure_kingdom } } } } }
                    }
                }
                if = {
                    limit = { NOT = { AND = { scope:target_county = { has_variable = Riseandfall_giveaway_blocked } scope:liege = { is_ai = no } } } }
                    create_title_and_vassal_change = { type = granted save_scope_as = change }
                    scope:target_county = { change_title_holder_include_vassals = { holder = scope:liege change = scope:change take_baronies = no } }
                    resolve_title_and_vassal_change = scope:change
                    scope:liege = { set_variable = { name = riseandfall_fix_bordergore_made_changes value = 1 } }
                }
            }
        }
    }

    # 3. Aggregate notification.
    scope:liege = {
        if = {
            limit = { has_variable = riseandfall_fix_bordergore_made_changes }
            send_interface_message = {
                type = send_interface_message_good
                title = riseandfall_fix_bordergore_notification_title
                custom_tooltip = { text = riseandfall_fix_bordergore_notification_desc_aggregate }
                left_icon = scope:liege
            }
            remove_variable = riseandfall_fix_bordergore_made_changes
        }
    }
}
