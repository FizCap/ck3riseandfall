riseandfall_warlord_roll_se = {
    trigger_event = { id = warlord.1003 }
}

riseandfall_inherit_warlord_trait_se = {
    # Inherit warlord trait from predecessor if the heir is not an independent ruler
    # Expected scope: heir
    # scope:predecessor should be saved as the predecessor
    if = {
        limit = {
            exists = scope:predecessor
            scope:predecessor = { has_trait = warlord }
            NOT = { is_independent_ruler = yes }  # heir is not an independent ruler
        }
        add_trait = warlord
    }
}

# Called from on_imprison when a liege imprisons one of their vassals.
# root = prisoner, scope:imprisoner = the imprisoning character
riseandfall_warlord_imprisoned_se = {
    # If the prisoner had the warlord trait and was imprisoned by their liege
    # remove warlord and mark them retired so they stop behaving as an
    # independent warlord while imprisoned.
    if = {
        limit = {
            has_trait = warlord
            # Check from the prisoner's scope: is the imprisoner the liege or above?
            target_is_liege_or_above = scope:imprisoner
        }
        remove_trait = warlord
    }
}

# Warlord legitimacy loss effect — called from yearly on_action tick
# Expected scope: character (liege with warlord vassals)
# Calculates legitimacy loss as: -100 × (warlord_vassals / total_vassals)
# Only applies to vassals at count tier or higher
riseandfall_warlord_legitimacy_loss_se = {
    # Guard: only applies to characters with legitimacy and warlord vassals
    if = {
        limit = {
            has_legitimacy = yes
            any_vassal = {
                primary_title.tier >= tier_county
                has_trait = warlord
            }
        }
        # Count total vassals at count tier or higher
        set_variable = { name = rf_total_vassals value = 0 }
        set_variable = { name = rf_warlord_vassals value = 0 }
        every_vassal = {
            limit = { primary_title.tier >= tier_county }
            prev = { change_variable = { name = rf_total_vassals add = 1 } }
            if = {
                limit = { has_trait = warlord }
                prev = { change_variable = { name = rf_warlord_vassals add = 1 } }
            }
        }
        # Calculate legitimacy loss: -100 × (warlord_vassals / total_vassals)
        # First, compute the ratio and multiply by -100
        if = {
            limit = { var:rf_total_vassals > 0 }
            set_variable = {
                name = rf_legitimacy_loss
                value = var:rf_warlord_vassals
            }
            change_variable = {
                name = rf_legitimacy_loss
                multiply = -100
            }
            change_variable = {
                name = rf_legitimacy_loss
                divide = var:rf_total_vassals
            }
            # Apply legitimacy loss (only if there's actually a loss)
            if = {
                limit = { var:rf_legitimacy_loss < 0 }
                add_legitimacy = var:rf_legitimacy_loss
            }
            # Cleanup temporary variables
            remove_variable = rf_legitimacy_loss
        }
        remove_variable = rf_total_vassals
        remove_variable = rf_warlord_vassals
    }
}