##################################################
# Rise and Fall — Puppet Master interactions
# Note: Some tokens here are placeholders pending your scripted effects/triggers; adjust as needed.

# Interaction: Steal Gold
riseandfall_steal_gold_interaction = {
	interface_priority = 100
	common_interaction = yes
	category = interaction_riseandfall
	icon = icon_riseandfall
	show_effects_in_notification = yes
	desc = riseandfall_steal_gold_interaction_desc
	diarch_interaction = yes

	# Show only to the active diarch targeting their liege while a puppet regency is active
	is_shown = {
		# Show to AI actors always, and to human players only when Lite Mode is disabled
		OR = {
			scope:actor = { is_ai = yes }
			AND = {
				scope:actor = { is_ai = no }
				has_game_rule = riseandfall_lite_mode_disabled
			}
		}

		scope:recipient = { has_diarchy_type = puppet_regency }
		# Only the diarch of that recipient should see/send this interaction
		scope:actor = { is_diarch_of_target = scope:recipient }
	}

	# Basic validity (no additional UI failures)
	is_valid_showing_failures_only = {
		# Only allow if the actor is the active diarch of the recipient
		scope:actor = { is_diarch_of_target = scope:recipient }
		riseandfall_liege_stability_below_50 = yes
		scope:recipient = {
			riseandfall_no_cooldown = yes
			riseandfall_liege_has_gold = yes
		}
	}

	# Auto-accept: this is a unilateral diarch action
	auto_accept = yes

	# Can send (AI and players)
	can_send = {
		# Ensure we have something to steal — leave precise value check to effect
		always = yes
	}
	# Allow AI to consider this interaction
	ai_potential = { always = yes }
	# Immediate execution (hidden)
	on_accept = {
		custom_tooltip = { text = riseandfall_steal_gold_interaction_desc }
		hidden_effect = {
			riseandfall_steal_gold_effect = yes
			scope:recipient = {
				send_interface_popup = {
					type = send_interface_message_bad
					title = riseandfall_steal_gold_popup_title
					custom_tooltip = riseandfall_steal_gold_popup_desc
					left_icon = scope:actor
				}
				every_vassal = {
					send_interface_message = {
						type = send_interface_message_bad
						title = riseandfall_steal_gold_vassal_notification_title
						custom_tooltip = riseandfall_steal_gold_vassal_notification_desc
						left_icon = scope:actor
					}
				}
			}
		}
	}

	# AI should always consider using it when available
	# How often AI considers this by top-title tier (months)
	ai_frequency = 12

    ai_targets = {
		ai_recipients = liege
		max = 1
	}

	ai_will_do = {
		# Opportunistic: steal gold from a liege. Prefer greedy / deceitful actors and disliked/weak lieges.
		base = 40

		modifier = { scope:actor = { has_trait = greedy } add = 40 }
		modifier = { scope:actor = { has_trait = deceitful } add = 30 }
		modifier = { scope:actor = { has_trait = ambitious } add = 20 }
		modifier = { scope:actor = { has_trait = honest } add = -30 }

		modifier = { scope:recipient = { opinion = { target = scope:actor value < 0 } } add = 45 }
		modifier = { scope:actor = { is_at_war = yes } add = -50 }
	}
}

# Interaction: Curry Favor (gain a strong favor hook)
riseandfall_curry_favor_interaction = {
	interface_priority = 90
	common_interaction = yes
	category = interaction_riseandfall
	icon = icon_riseandfall
	show_effects_in_notification = yes
	desc = riseandfall_curry_favor_interaction_desc
	diarch_interaction = yes

	is_shown = {
		OR = {
			scope:actor = { is_ai = yes }
			AND = {
				scope:actor = { is_ai = no }
				has_game_rule = riseandfall_lite_mode_disabled
			}
		}

		scope:recipient = { has_diarchy_type = puppet_regency }
		# Actor must be the diarch of this recipient
		scope:actor = { is_diarch_of_target = scope:recipient }
	}

	is_valid_showing_failures_only = { 
		# Only the diarch of the recipient may use this
		scope:actor = { is_diarch_of_target = scope:recipient }
		# Disallow curry favor if actor already has a strong favor hook on the recipient
		scope:actor = { NOT = { has_hook_of_type = { target = scope:recipient type = strong_favor_hook } } }
		scope:recipient = { 
			riseandfall_no_cooldown = yes
			riseandfall_no_existing_hook = yes
		} 
	}

	auto_accept = yes

	on_accept = {
		custom_tooltip = { text = riseandfall_curry_favor_interaction_desc }
		hidden_effect = {
			riseandfall_curry_favor_effect = yes
			scope:recipient = {
				send_interface_popup = {
					type = send_interface_message_bad
					title = riseandfall_curry_favor_popup_title
					custom_tooltip = riseandfall_curry_favor_popup_desc
					left_icon = scope:actor
				}
				every_vassal = {
					send_interface_message = {
						type = send_interface_message_bad
						title = riseandfall_curry_favor_vassal_notification_title
						custom_tooltip = riseandfall_curry_favor_vassal_notification_desc
						left_icon = scope:actor
					}
				}
			}
		}
	}
	# How often AI considers this by top-title tier (months)
	ai_frequency = 12
	# Allow AI to consider this interaction
	ai_potential = { always = yes }

    ai_targets = {
		ai_recipients = liege
		max = 1
	}

	ai_will_do = {
		# Curry favor: manipulation to gain hooks. Preferred by ambitious/deceitful actors; penalize honest/just actors.
		base = 40

		modifier = { scope:actor = { has_trait = ambitious } add = 30 }
		modifier = { scope:actor = { has_trait = deceitful } add = 30 }
		modifier = { scope:actor = { has_trait = greedy } add = 20 }
		modifier = { scope:actor = { has_trait = honest } add = -30 }
		modifier = { scope:actor = { has_trait = just } add = -20 }

		# If the liege already likes the diarch, easier to curry favor; otherwise it's harder.
		modifier = { scope:recipient = { opinion = { target = scope:actor value >= 30 } } add = 20 }
		modifier = { scope:recipient = { opinion = { target = scope:actor value <= -20 } } add = -20 }

		modifier = { scope:actor = { is_at_war = yes } add = -30 }
	}
}

# Interaction: Overthrow Liege (transfer all titles to diarch)
riseandfall_overthrow_liege_interaction = {
	interface_priority = 80
	common_interaction = no
	category = interaction_riseandfall
	icon = icon_riseandfall
	show_effects_in_notification = yes
	desc = riseandfall_overthrow_liege_interaction_desc
	diarch_interaction = yes

	is_shown = {
		OR = {
			scope:actor = { is_ai = yes }
			AND = {
				scope:actor = { is_ai = no }
				has_game_rule = riseandfall_lite_mode_disabled
			}
		}

		scope:recipient = { has_diarchy_type = puppet_regency }
		# Restrict this to the recipient's active diarch
		scope:actor = { is_diarch_of_target = scope:recipient }
	}

	# Gate on stability < 30
	is_valid_showing_failures_only = {
		# Only allow the active diarch to perform this
		scope:actor = { is_diarch_of_target = scope:recipient }
		riseandfall_liege_stability_below_30 = yes
		riseandfall_puppet_regency_years_at_least_5 = yes
		riseandfall_no_low_stability_cooldown = yes
	}

	auto_accept = yes

	on_accept = {
		custom_tooltip = { text = riseandfall_overthrow_liege_interaction_desc }
		hidden_effect = {
			riseandfall_overthrow_liege_effect = yes
			scope:recipient = {
				send_interface_popup = {
					type = send_interface_message_bad
					title = riseandfall_overthrow_liege_popup_title
					custom_tooltip = riseandfall_overthrow_liege_popup_desc
					left_icon = scope:actor
				}
				every_vassal = {
					send_interface_message = {
						type = send_interface_message_bad
						title = riseandfall_overthrow_liege_vassal_notification_title
						custom_tooltip = riseandfall_overthrow_liege_vassal_notification_desc
						left_icon = scope:actor
					}
				}
			}
		}
	}
	# How often AI considers this by top-title tier (months)
	ai_frequency = 12
	# Allow AI to consider this interaction
	ai_potential = { always = yes }

    ai_targets = {
		ai_recipients = liege
		max = 1
	}

	# Rare/conditional
	ai_will_do = {
		# Overthrow: major action — usually rare but strong when conditions are favorable (ambitious actors, weak liege)
		base = -1000

		modifier = { scope:actor = { has_trait = ambitious } add = 300 }
		modifier = { scope:actor = { has_trait = greedy } add = 200 }
		modifier = { scope:actor = { has_trait = vengeful } add = 150 }
		modifier = { scope:actor = { has_trait = deceitful } add = 80 }
		modifier = { scope:actor = { has_trait = honest } add = -200 }

		# If liege dislikes the diarch, more impetus to overthrow
		modifier = { scope:recipient = { opinion = { target = scope:actor value < 0 } } add = 200 }

		# Military strength comparisons removed: Puppetmaster operates politically rather than through direct force

		# Penalize if actor is at war (avoid opening the realm to internal conflict)
		modifier = { scope:actor = { is_at_war = yes } add = -200 }
	}
}

# Interaction: Force Liege to Abdicate (use poor health to influence abdication)
riseandfall_force_abdicate_interaction = {
	interface_priority = 85
	common_interaction = yes
	category = interaction_riseandfall
	icon = icon_riseandfall
	show_effects_in_notification = yes
	desc = riseandfall_force_abdicate_interaction_desc
	diarch_interaction = yes

	is_shown = {
		OR = {
			scope:actor = { is_ai = yes }
			AND = {
				scope:actor = { is_ai = no }
				has_game_rule = riseandfall_lite_mode_disabled
			}
		}
		scope:recipient = { has_diarchy_type = puppet_regency }
		# Only visible to the recipient's diarch
		scope:actor = { is_diarch_of_target = scope:recipient }
	}

	# Show only when liege has poor health and no cooldown
	is_valid_showing_failures_only = {
		# Only the diarch should be allowed to do this
		scope:actor = { is_diarch_of_target = scope:recipient }
		scope:recipient = {
			riseandfall_liege_has_poor_health = yes
		}
	}

	auto_accept = yes

	on_accept = {
		custom_tooltip = { text = riseandfall_force_abdicate_interaction_desc }
		hidden_effect = {
			riseandfall_force_abdicate_effect = yes
			scope:recipient = {
				send_interface_popup = {
					type = send_interface_message_bad
					title = riseandfall_force_abdicate_popup_title
					custom_tooltip = riseandfall_force_abdicate_popup_desc
					left_icon = scope:actor
				}
				every_vassal = {
					send_interface_message = {
						type = send_interface_message_bad
						title = riseandfall_force_abdicate_vassal_notification_title
						custom_tooltip = riseandfall_force_abdicate_vassal_notification_desc
						left_icon = scope:actor
					}
				}
			}
		}
	}

	# How often AI considers this by top-title tier (months)
	ai_frequency = 1
	ai_potential = { always = yes }
	ai_targets = { ai_recipients = liege max = 1 }
	ai_will_do = {
		# Force abdicate: pushing a weak liege to abdicate. Prefer ambitious/vengeful actors targeting weak/disliked lieges.
		base = 20

		modifier = { scope:actor = { has_trait = ambitious } add = 60 }
		modifier = { scope:actor = { has_trait = vengeful } add = 40 }
		modifier = { scope:actor = { has_trait = greedy } add = 20 }
		modifier = { scope:actor = { has_trait = honest } add = -40 }
		modifier = { scope:actor = { has_trait = just } add = -30 }

		modifier = { scope:recipient = { opinion = { target = scope:actor value < 0 } } add = 35 }
		modifier = { scope:recipient = { opinion = { target = scope:actor value >= 60 } } add = -30 }
		modifier = { scope:actor = { is_at_war = yes } add = -60 }
	}
}
