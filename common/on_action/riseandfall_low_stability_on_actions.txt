yearly_global_pulse = {
    on_actions = {
        riseandfall_low_stability_roll
        riseandfall_check_puppet_regency
        riseandfall_warlord
        riseandfall_marry_male_puppet_master_target
        riseandfall_marry_female_puppet_master_target
    }
}

on_imprison = {
    on_actions = {
        riseandfall_warlord_imprisoned
    }
}

riseandfall_low_stability_roll = {
    trigger = {
        has_game_rule = riseandfall_low_stability_events_enabled
    }
    effect = {
        riseandfall_dynamic_story_mode_se = yes
        every_independent_ruler = {
            limit = {
                is_landed = yes
                # Only rulers whose primary title is duchy or higher (duke+)
                primary_title.tier >= tier_duchy
            }
            save_scope_as = ruler_low_stability
            riseandfall_low_stability_roll_se = yes
        }
    }
}

riseandfall_check_puppet_regency = {
    trigger = {
        has_game_rule = riseandfall_low_stability_events_enabled
    }
    effect = {
        riseandfall_check_puppet_regency_end = yes
    }
}


riseandfall_warlord = {
    effect = {
        # For independent rulers who are warlords, mark them retired warlords
        every_independent_ruler = {
            limit = { has_trait = warlord }
            remove_trait = warlord
            add_trait = retiredwarlord
        }

        # For non-independent rulers who were retired warlords, restore the warlord trait so they act
        every_ruler = {
            limit = { is_independent_ruler = no has_trait = retiredwarlord }
            remove_trait = retiredwarlord
            add_trait = warlord
        }

        # For non-independent rulers who are warlords, run the usual scripted effect
        every_ruler = {
            limit = { is_independent_ruler = no has_trait = warlord }
            riseandfall_warlord_roll_se = yes
        }
    }
}

# Rise and Fall: respond to imprison actions
# root = prisoner, scope:imprisoner = the character who imprisoned them
# If a warlord is imprisoned by their liege, remove the warlord trait so they stop behaving as an independent warlord
# Call the scripted effect which handles warlord trait removal when a liege imprisons a vassal
riseandfall_warlord_imprisoned = {
    effect = {
        # root = prisoner, scope:imprisoner = the character who imprisoned them
        # Call the scripted effect which handles warlord trait removal when a liege imprisons a vassal
        riseandfall_warlord_imprisoned_se = yes
    }
}


# On_actions for puppet masters (diarchs): AI-only unlanded diarchs should be given spouses by their liege's court.
# We iterate each ruler with a puppet_regency diarchy and pick any courtier who is that ruler's diarch, then call the marriage scripted effects.
riseandfall_marry_male_puppet_master_target = {
    effect = {
        every_ruler = {
            limit = { has_diarchy_type = puppet_regency }
            save_scope_as = liege
            every_courtier = {
                limit = {
                    is_diarch_of_target = scope:liege
                    is_ai = yes
                    is_landed = no
                    is_ruler = no
                    is_male = yes
                    is_adult = yes
                    is_married = no
                    is_betrothed = no
                }
                save_scope_as = diarch_candidate
                # call the scripted effect on the diarch character (root)
                riseandfall_marry_puppet_master_male_se = yes
            }
        }
    }
}

riseandfall_marry_female_puppet_master_target = {
    effect = {
        every_independent_ruler = {
            limit = { has_diarchy_type = puppet_regency }
            save_scope_as = liege
            every_courtier = {
                limit = {
                    is_diarch_of_target = scope:liege
                    is_ai = yes
                    is_landed = no
                    is_ruler = no
                    is_female = yes
                    is_adult = yes
                    is_married = no
                    is_betrothed = no
                }
                save_scope_as = diarch_candidate
                # call the scripted effect on the diarch character (root)
                riseandfall_marry_puppet_master_female_se = yes
            }
        }
    }
}
