yearly_global_pulse = {
    on_actions = {
        riseandfall_low_stability_roll
        riseandfall_warlord
    }
}

on_imprison = {
    on_actions = {
        riseandfall_warlord_imprisoned
    }
}

riseandfall_low_stability_roll = {
    trigger = {
        has_game_rule = riseandfall_low_stability_events_enabled
    }
    effect = {
        riseandfall_dynamic_story_mode_se = yes
        every_independent_ruler = {
            limit = {
                is_landed = yes
                # Only rulers whose primary title is duchy or higher (duke+)
                primary_title.tier >= tier_duchy
            }
            save_scope_as = ruler_low_stability
            riseandfall_low_stability_roll_se = yes
        }
    }
}


riseandfall_warlord = {
    effect = {
        # For independent rulers who are warlords, mark them retired warlords
        every_independent_ruler = {
            limit = { has_trait = warlord }
            remove_trait = warlord
            add_trait = retiredwarlord
        }

        # For non-independent rulers who were retired warlords, restore the warlord trait so they act
        every_ruler = {
            limit = { is_independent_ruler = no has_trait = retiredwarlord }
            remove_trait = retiredwarlord
            add_trait = warlord
        }

        # For non-independent rulers who are warlords, run the usual scripted effect
        every_ruler = {
            limit = { is_independent_ruler = no has_trait = warlord }
            riseandfall_warlord_roll_se = yes
        }
    }
}

# Rise and Fall: respond to imprison actions
# root = prisoner, scope:imprisoner = the character who imprisoned them
# If a warlord is imprisoned by their liege, remove the warlord trait so they stop behaving as an independent warlord
# Call the scripted effect which handles warlord trait removal when a liege imprisons a vassal
riseandfall_warlord_imprisoned = {
    effect = {
        # root = prisoner, scope:imprisoner = the character who imprisoned them
        # Call the scripted effect which handles warlord trait removal when a liege imprisons a vassal
        riseandfall_warlord_imprisoned_se = yes
    }
}