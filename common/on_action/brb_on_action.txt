on_death = {
	on_actions = {
		on_death_brb
	}
}

on_war_won_attacker = {
	on_actions = {
		brb_war_won
	}
}

on_death_brb = {
	effect = {
		if = {
			limit = {
				exists = scope:killer
				scope:killer = {
					is_independent_ruler = yes
				}
			}
			save_scope_as = killed_man
			every_close_family_member = { # find family members
				limit = {
					this.liege = scope:killer
					highest_held_title_tier >= tier_county
					is_at_war_with_liege = no
					is_imprisoned = no
				}
				add_to_list = brb_members
			}
			if = {
				limit = {
					exists = scope:killed_man.primary_heir
					scope:killed_man.primary_heir.liege = scope:killer
					scope:killed_man.primary_heir = {
						age > 10
					}
					
				}
				if = {
					limit = {
						scope:killed_man.primary_heir = {
							is_in_list = brb_members
						}
					}
					scope:killed_man.primary_heir = {
						save_scope_as = brb_highest_title_man
						remove_from_list = brb_members
					}
				}
				else = {
					scope:killed_man.primary_heir = {
						save_scope_as = brb_highest_title_man
					}
				}
				
			}
			if = {
				limit = {
					NOT = { exists = scope:brb_highest_title_man }
				}
				ordered_in_list = {
					list = brb_members
					order_by = highest_held_title_tier
					position = 0
					save_scope_as = brb_highest_title_man
					remove_from_list = brb_members
				}
			}
			scope:brb_highest_title_man = {
				trigger_event = {
					id = brb.3
					days = 1
				}
			}
			every_in_list = {
				list = brb_members
				trigger_event = {
					id = brb.4
					days = 4
				}
				remove_from_list = brb_members
			}
		}
	}
}

brb_war_won = {
	effect = {
		if = {
			limit = {
				scope:war = {
					OR = {
						using_cb = liberty_faction_war
						using_cb = refused_liege_demand_war
						#using_cb = depose_war
					}
				}
			}
			scope:defender = {
				save_scope_as = brb_prev_liege
			}
			scope:defender.primary_title = {
				save_scope_as = brb_liege_primary_title
			}
			
			scope:attacker.liege = {
				save_scope_as = brb_liege
			}
			scope:attacker = {
				save_scope_as = brb_rebellion_leader
			}
			scope:war = {
				ordered_war_attacker = {
					limit = {
						is_vassal_of = scope:brb_liege 
					}
					order_by = { 
						add = current_military_strength
						add = {
							value = diplomacy
							multiply = 35
						}
						add = {
							value = martial
							multiply = 50
						}
						add = {
							value = stewardship
							multiply = 20
						}
						add = {
							value = intrigue
							multiply = 20
						}
						add = {
							value = learning
							multiply = 20
						}
					}
					save_scope_as = brb_contender
				}
			}
			
			if = {
				limit = {
					OR = {
						#strongest military contender
						AND = {
							scope:brb_contender = { 
								current_military_strength > scope:brb_rebellion_leader.current_military_strength
							}
							scope:war = { 
								war_contribution = {
									target = scope:brb_contender 
									value > 40%
								}
							}
						}
						#diplomatic option
						AND = {
							scope:brb_contender = { 
								diplomacy > scope:brb_rebellion_leader.diplomacy
								martial > scope:brb_rebellion_leader.martial
								current_military_strength > scope:brb_rebellion_leader.current_military_strength
							}
							scope:war = { 
								war_contribution = {
									target = scope:brb_contender 
									value > 25%
								}
							}
						}
					}
				}
				scope:brb_contender = {
					clear_saved_scope = brb_contender
					save_scope_as = brb_attacker
				}
			}
			else = {
				scope:brb_rebellion_leader = {
					clear_saved_scope = brb_rebellion_leader
					save_scope_as = brb_attacker
				}
			}

			scope:defender = {
				trigger_event = {
					id = brb.5 #everything is falling apart!
				}
			}
		}
	}
}