yearly_global_pulse = {
    on_actions = {
        riseandfall_yearly_adventurer
        riseandfall_yearly_remove_adventurer_gold_mod
        riseandfall_marry_male_target_se
        riseandfall_marry_female_target_se
        riseandfall_yearly_adventurer_press_claims
        riseandfall_yearly_adventurer_cleanup_on_action
        riseandfall_yearly_mma_limit_cap_increase
        riseandfall_yearly_maa_limit_increase
    }
}

riseandfall_yearly_maa_limit_increase = {
    trigger = {
        has_game_rule = riseandfall_mma_modifier_enabled
    }

    effect = {
        every_ruler = {
            limit = {
                NOT = { has_character_modifier = riseandfall_yearly_maa_limit_increase_effect }
            }
            add_character_modifier = riseandfall_yearly_maa_limit_increase_modifier
        }
    }
}


riseandfall_yearly_mma_limit_cap_increase = {
    trigger = {
        has_game_rule = riseandfall_mma_limit_modifier_enabled
    }
    effect = {
        every_ruler = {
            limit = {
                NOT = { has_character_modifier = riseandfall_yearly_maa_limit_cap_increase_modifier }
            }
            add_character_modifier = riseandfall_yearly_maa_limit_cap_increase_modifier
        }
    }
}   


riseandfall_yearly_adventurer = {
    trigger = {
        has_game_rule = riseandfall_adventurer_creator_enabled
    }

    effect = {
        every_ruler = {
            limit = { is_dynast = yes }
            save_scope_as = independent_ruler
            riseandfall_check_dynasty_for_adventurers_se = yes
        }
    }
}


riseandfall_yearly_adventurer_press_claims = {
    effect = {
        every_ruler = {
            limit = {
                has_character_flag = riseandfall_newadventurer
                is_at_war = no
                has_realm_law = camp_purpose_legitimists
                is_imprisoned = no
            }
            save_scope_as = independent_adventurer
            # call the scripted effect on the adventurer leader
            riseandfall_adventurer_press_claims_se = yes
        }
    }
}

# Pay adventurer income quarterly; root scope is each playable character. We'll iterate rulers with the gold mod.
quarterly_playable_pulse = {
    on_actions = {
        riseandfall_quarterly_adventurer_income
    }
}

# Helper on_action: iterate adventurers and pay quarterly income
riseandfall_quarterly_adventurer_income = {
    effect = {
        every_ruler = {
            limit = {
                has_character_modifier = riseandfall_adventurer_gold_mod
                has_government = landless_adventurer_government
                is_landed = no
                is_imprisoned = no
            }
            riseandfall_adventurer_quarterly_income_se = yes
        }
    }
}


# Find every character with the adventurer gold modifier and run the removal check
riseandfall_yearly_remove_adventurer_gold_mod = {
    effect = {
        every_ruler = {
            limit = {
                has_character_modifier = riseandfall_adventurer_gold_mod
                NOT = { has_government = landless_adventurer_government }
            }

            riseandfall_remove_adventurer_gold_mod_if_not_landless_se = yes
        }
    }
}


# On_action that runs yearly to marry male landless adventurers (creates female spouse)
riseandfall_marry_male_target_se = {
    effect = {
        every_ruler = {
            limit = {
                is_male = yes
                is_adult = yes
                is_married = no
                is_betrothed = no
                has_realm_law = camp_purpose_legitimists
            }

            save_scope_as = independent_ruler

            # Defer character-level checks to the scripted effect for performance.
            riseandfall_marry_male_target_se = yes
        }
    }
}


# On_action that runs yearly to marry female landless adventurers (creates male spouse)
riseandfall_marry_female_target_se = {
    effect = {
        every_ruler = {
            limit = {
                is_female = yes
                is_adult = yes
                is_married = no
                is_betrothed = no
                has_realm_law = camp_purpose_legitimists
            }

            save_scope_as = independent_ruler
            riseandfall_marry_female_target_se = yes
        }
    }
}


# Monthly cleanup: run the adventurer cleanup scripted effect (previously in a separate file)
riseandfall_yearly_adventurer_cleanup_on_action = {
    trigger = {
        has_game_rule = riseandfall_adventurer_cleanup
    }
    effect = {
            riseandfall_adventurer_cleanup_se = yes
        }
    }


